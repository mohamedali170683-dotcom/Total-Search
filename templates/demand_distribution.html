<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Search Distribution - Total Search</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        [x-cloak] { display: none !important; }
        * { font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; }
        .card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08), 0 4px 12px rgba(0,0,0,0.04);
            border: 1px solid rgba(0,0,0,0.06);
        }
        .card-hover:hover {
            box-shadow: 0 4px 20px rgba(0,0,0,0.08), 0 8px 24px rgba(0,0,0,0.06);
            transform: translateY(-1px);
            transition: all 0.2s ease;
        }
        .platform-bar {
            transition: width 0.8s ease-out;
        }
        .btn-primary {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            transition: all 0.2s ease;
        }
        .btn-primary:hover {
            background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
        }
        .insight-card {
            transition: all 0.2s ease;
        }
        .insight-card:hover {
            transform: translateY(-2px);
        }
        .select-modern {
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%236b7280'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            background-size: 16px;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 min-h-screen" x-data="demandDashboard()">
    <!-- Header -->
    <header class="bg-white/80 backdrop-blur-lg border-b border-slate-200/60 sticky top-0 z-50">
        <div class="max-w-6xl mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-blue-500 to-indigo-600 flex items-center justify-center">
                        <i class="fas fa-chart-pie text-white text-lg"></i>
                    </div>
                    <div>
                        <h1 class="text-lg font-semibold text-slate-900">Total Search</h1>
                        <span class="text-xs text-slate-500">Cross-Platform Search Intelligence</span>
                    </div>
                </div>
                <nav class="flex items-center space-x-2">
                    <a href="/home" class="px-4 py-2 rounded-lg text-slate-600 hover:bg-slate-100 text-sm font-medium transition">
                        Keywords
                    </a>
                    <a href="/demand" class="px-4 py-2 rounded-lg bg-blue-50 text-blue-600 text-sm font-medium">
                        Demand
                    </a>
                    <a href="/compare" class="px-4 py-2 rounded-lg text-slate-600 hover:bg-slate-100 text-sm font-medium transition">
                        Compare
                    </a>
                </nav>
            </div>
        </div>
    </header>

    <main class="max-w-6xl mx-auto px-6 py-8">
        <!-- Search Section -->
        <div class="card p-6 mb-8">
            <div class="flex items-center justify-between mb-6">
                <div>
                    <h2 class="text-xl font-semibold text-slate-900">Analyze Search Distribution</h2>
                    <p class="text-slate-500 text-sm mt-1">
                        Discover where your audience searches across platforms
                    </p>
                </div>
            </div>

            <div class="space-y-4">
                <!-- Main Search Input -->
                <div class="flex flex-col lg:flex-row gap-4">
                    <div class="flex-1">
                        <label class="block text-sm font-medium text-slate-700 mb-2">Keywords</label>
                        <input
                            type="text"
                            x-model="searchQuery"
                            @keyup.enter="analyzeKeywords()"
                            placeholder="Enter keywords (comma-separated)"
                            class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 transition"
                        >
                    </div>

                    <!-- Country Selector -->
                    <div class="w-full lg:w-48">
                        <label class="block text-sm font-medium text-slate-700 mb-2">Country</label>
                        <select
                            x-model="selectedCountry"
                            class="select-modern w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 transition pr-10"
                        >
                            <option value="us">United States</option>
                            <option value="de">Germany</option>
                            <option value="uk">United Kingdom</option>
                            <option value="fr">France</option>
                            <option value="es">Spain</option>
                            <option value="it">Italy</option>
                            <option value="nl">Netherlands</option>
                            <option value="au">Australia</option>
                            <option value="ca">Canada</option>
                            <option value="br">Brazil</option>
                            <option value="mx">Mexico</option>
                            <option value="jp">Japan</option>
                        </select>
                    </div>

                    <!-- Language Selector -->
                    <div class="w-full lg:w-48">
                        <label class="block text-sm font-medium text-slate-700 mb-2">Language</label>
                        <select
                            x-model="selectedLanguage"
                            class="select-modern w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 transition pr-10"
                        >
                            <option value="en">English</option>
                            <option value="de">German</option>
                            <option value="fr">French</option>
                            <option value="es">Spanish</option>
                            <option value="it">Italian</option>
                            <option value="nl">Dutch</option>
                            <option value="pt">Portuguese</option>
                            <option value="ja">Japanese</option>
                        </select>
                    </div>

                    <!-- Audience Profile Selector -->
                    <div class="w-full lg:w-56">
                        <label class="block text-sm font-medium text-slate-700 mb-2">Audience Profile</label>
                        <select
                            x-model="selectedProfile"
                            class="select-modern w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 transition pr-10"
                        >
                            <option value="general">General (default)</option>
                            <option value="ecommerce">E-commerce</option>
                            <option value="beauty">Beauty &amp; Lifestyle</option>
                            <option value="gen_z">Gen Z Audience</option>
                            <option value="b2b_tech">B2B / Technology</option>
                            <option value="video_content">Video &amp; Content</option>
                        </select>
                    </div>
                </div>

                <!-- Search Button -->
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-4">
                        <div class="flex flex-wrap gap-2">
                            <span class="text-xs text-slate-400">Try:</span>
                            <button @click="searchQuery = 'lavera cosmetics'; analyzeKeywords()" class="text-xs text-blue-600 hover:text-blue-700 font-medium transition">Cosmetics</button>
                            <button @click="searchQuery = 'running shoes'; analyzeKeywords()" class="text-xs text-blue-600 hover:text-blue-700 font-medium transition">Running</button>
                            <button @click="searchQuery = 'meal prep recipes'; analyzeKeywords()" class="text-xs text-blue-600 hover:text-blue-700 font-medium transition">Food</button>
                        </div>
                        <label class="flex items-center space-x-2 text-xs text-slate-500 cursor-pointer">
                            <input type="checkbox" x-model="forceRefresh" class="rounded border-slate-300 text-blue-600 focus:ring-blue-500">
                            <span>Force refresh data</span>
                        </label>
                    </div>

                    <button
                        @click="analyzeKeywords()"
                        :disabled="isLoading || !searchQuery.trim()"
                        class="btn-primary px-6 py-3 text-white rounded-xl font-medium disabled:opacity-50 disabled:cursor-not-allowed flex items-center space-x-2"
                    >
                        <i :class="isLoading ? 'fas fa-circle-notch fa-spin' : 'fas fa-search'"></i>
                        <span x-text="isLoading ? 'Analyzing...' : 'Analyze'"></span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Results Section -->
        <div x-show="hasResults" x-cloak>
            <!-- Executive Summary — 3 answers in 3 sentences -->
            <div class="card p-5 mb-8 bg-gradient-to-r from-slate-900 to-slate-800 border-slate-700">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <!-- Q1 answer -->
                    <div class="flex items-start gap-3">
                        <span class="inline-flex items-center justify-center w-6 h-6 rounded-full bg-blue-500 text-white text-xs font-bold flex-shrink-0 mt-0.5">1</span>
                        <div>
                            <p class="text-xs font-medium text-blue-300 uppercase tracking-wide">Where</p>
                            <p class="text-sm text-white mt-0.5">
                                <span class="font-bold" x-text="formatNumber(getTotalVolume())"></span> monthly volume across
                                <span class="font-bold" x-text="(results?.platforms || []).filter(p => p.volume > 0).length"></span> platforms.
                                <span x-text="results?.distribution_summary?.top_platform_name || '-'"></span> leads with
                                <span x-text="getTopPlatformShare() + '%'"></span>.
                            </p>
                        </div>
                    </div>
                    <!-- Q2 answer -->
                    <div class="flex items-start gap-3">
                        <span class="inline-flex items-center justify-center w-6 h-6 rounded-full bg-indigo-500 text-white text-xs font-bold flex-shrink-0 mt-0.5">2</span>
                        <div>
                            <p class="text-xs font-medium text-indigo-300 uppercase tracking-wide">What drives it</p>
                            <p class="text-sm text-white mt-0.5" x-text="getExecSummaryQ2()"></p>
                        </div>
                    </div>
                    <!-- Q3 answer -->
                    <div class="flex items-start gap-3">
                        <span class="inline-flex items-center justify-center w-6 h-6 rounded-full bg-violet-500 text-white text-xs font-bold flex-shrink-0 mt-0.5">3</span>
                        <div>
                            <p class="text-xs font-medium text-violet-300 uppercase tracking-wide">Behavior</p>
                            <p class="text-sm text-white mt-0.5" x-text="getExecSummaryQ3()"></p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Q1 Header: Where are users searching? -->
            <div class="mb-6">
                <h2 class="text-lg font-bold text-slate-900">
                    <span class="inline-flex items-center justify-center w-7 h-7 rounded-full bg-blue-600 text-white text-sm font-bold mr-2">1</span>
                    Where are users searching?
                </h2>
                <p class="text-sm text-slate-500 mt-1 ml-9">Total search volume across platforms — where the demand actually lives</p>
            </div>

            <!-- Summary Stats Row -->
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-6">
                <div class="card card-hover p-5 bg-gradient-to-br from-blue-50 to-indigo-50 border-blue-100">
                    <p class="text-xs font-medium text-blue-600 uppercase tracking-wide">Total Search Volume</p>
                    <p class="text-3xl font-bold text-blue-700 mt-1" x-text="formatNumber(getTotalVolume())"></p>
                    <p class="text-xs text-blue-400 mt-1">monthly across all platforms</p>
                </div>
                <div class="card card-hover p-5">
                    <p class="text-xs font-medium text-slate-500 uppercase tracking-wide">Active Platforms</p>
                    <p class="text-2xl font-bold text-slate-900 mt-1" x-text="(results?.platforms || []).filter(p => p.volume > 0).length + ' / 6'"></p>
                    <p class="text-xs text-slate-400 mt-1">platforms with demand signals</p>
                </div>
                <div class="card card-hover p-5">
                    <p class="text-xs font-medium text-slate-500 uppercase tracking-wide">Top Platform</p>
                    <p class="text-2xl font-bold text-slate-900 mt-1" x-text="results?.distribution_summary?.top_platform_name || '-'"></p>
                    <p class="text-xs text-slate-400 mt-1">
                        <span x-text="getTopPlatformShare() + '% of total volume'"></span>
                    </p>
                </div>
            </div>

            <!-- Main Content Grid -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                <!-- Unified Demand Distribution Chart -->
                <div class="lg:col-span-2 card p-6">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-lg font-semibold text-slate-900">Search Distribution</h3>
                        <div class="flex space-x-2">
                            <button @click="exportPDF()" class="px-3 py-1.5 text-xs font-medium text-slate-600 bg-slate-100 hover:bg-slate-200 rounded-lg transition">
                                <i class="fas fa-file-pdf mr-1"></i> PDF
                            </button>
                            <button @click="exportPPTX()" class="px-3 py-1.5 text-xs font-medium text-slate-600 bg-slate-100 hover:bg-slate-200 rounded-lg transition">
                                <i class="fas fa-file-powerpoint mr-1"></i> PPTX
                            </button>
                        </div>
                    </div>

                    <div class="flex flex-col lg:flex-row gap-8">
                        <!-- Unified Chart (all 6 platforms, volume-based share) -->
                        <div class="w-full lg:w-2/5 flex items-center justify-center">
                            <div class="relative">
                                <canvas id="distributionChart" width="220" height="220"></canvas>
                                <div class="absolute inset-0 flex items-center justify-center pointer-events-none">
                                    <div class="text-center">
                                        <p class="text-2xl font-bold text-blue-700" x-text="formatNumber(getTotalVolume())"></p>
                                        <p class="text-xs text-slate-500">Total Volume</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- All Platforms — Volume Share -->
                        <div class="flex-1">
                            <p class="text-xs font-semibold text-slate-400 uppercase tracking-wider mb-3">
                                <i class="fas fa-chart-bar mr-1"></i> Volume Share by Platform
                            </p>
                            <div class="space-y-3">
                                <template x-for="platform in (results?.platforms || []).filter(p => p.volume > 0)" :key="platform.platform">
                                    <div class="flex items-center group">
                                        <div class="w-8 h-8 rounded-lg flex items-center justify-center" :style="'background-color: ' + platform.color + '15'">
                                            <i :class="platform.icon" :style="'color: ' + platform.color" class="text-sm"></i>
                                        </div>
                                        <div class="flex-1 ml-3">
                                            <div class="flex justify-between text-sm mb-1">
                                                <div class="flex items-center space-x-2">
                                                    <span class="font-medium text-slate-700" x-text="platform.display_name"></span>
                                                    <span class="text-[10px] px-1.5 py-0.5 rounded-full font-medium bg-blue-100 text-blue-700"
                                                        x-text="getPlatformVolumeShare(platform) + '%'"></span>
                                                    <span x-show="platform.is_demo" class="text-[9px] px-1.5 py-0.5 rounded-full bg-slate-200 text-slate-500 font-medium">Demo</span>
                                                </div>
                                                <div class="flex items-center space-x-2">
                                                    <span class="text-slate-900 font-bold text-base" x-text="formatNumber(platform.volume)"></span>
                                                    <span class="text-slate-400 text-xs" x-text="platform.metric_label.toLowerCase()"></span>
                                                </div>
                                            </div>
                                            <div class="h-2 bg-slate-100 rounded-full overflow-hidden">
                                                <div class="h-full rounded-full platform-bar" :style="'width: ' + Math.max(getPlatformVolumeShare(platform), 1) + '%; background-color: ' + platform.color"></div>
                                            </div>
                                        </div>
                                        <div class="w-10 text-right ml-3">
                                            <span x-show="platform.trend === 'growing'" class="text-green-500 text-sm"><i class="fas fa-arrow-up"></i></span>
                                            <span x-show="platform.trend === 'declining'" class="text-red-500 text-sm"><i class="fas fa-arrow-down"></i></span>
                                            <span x-show="platform.trend === 'stable' || !platform.trend" class="text-slate-300 text-sm"><i class="fas fa-minus"></i></span>
                                        </div>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Key Insight Panel -->
                <div class="card p-6 bg-gradient-to-br from-blue-50 to-indigo-50 border-blue-100">
                    <h3 class="text-lg font-semibold text-slate-900 mb-4">Volume Overview</h3>

                    <div class="text-center py-4">
                        <p class="text-4xl font-bold text-blue-600" x-text="formatNumber(getTotalVolume())"></p>
                        <p class="text-slate-500 mt-1 font-medium text-sm">Total Monthly Volume</p>
                    </div>

                    <div class="bg-white/60 rounded-xl p-4 mt-3">
                        <p class="text-sm text-slate-600">
                            <span class="font-bold text-slate-900" x-text="results?.distribution_summary?.top_platform_name || '-'"></span>
                            leads with
                            <span class="font-bold text-blue-600" x-text="getTopPlatformShare() + '%'"></span>
                            of total volume
                        </p>
                    </div>

                    <!-- Platform volume breakdown -->
                    <div class="mt-3 bg-white/40 rounded-xl p-3 space-y-2">
                        <p class="text-xs font-semibold text-slate-500 uppercase tracking-wide">Volume by Platform</p>
                        <template x-for="platform in (results?.platforms || []).filter(p => p.volume > 0)" :key="'insight-' + platform.platform">
                            <div class="flex items-center justify-between text-sm">
                                <span class="text-slate-600">
                                    <i :class="platform.icon" class="mr-1" :style="'color: ' + platform.color"></i>
                                    <span x-text="platform.display_name"></span>
                                </span>
                                <div class="flex items-center gap-2">
                                    <span class="font-semibold text-slate-800" x-text="formatNumber(platform.volume)"></span>
                                    <span class="text-[10px] text-slate-400" x-text="getPlatformVolumeShare(platform) + '%'"></span>
                                </div>
                            </div>
                        </template>
                    </div>

                    <div class="mt-3 pt-3 border-t border-blue-100">
                        <p class="text-xs text-slate-500">
                            <i class="fas fa-globe mr-1"></i>
                            Data for: <span x-text="getCountryName()" class="font-medium"></span>
                        </p>
                    </div>
                </div>
            </div>

            <!-- Insights & Recommendations — Collapsible -->
            <div class="card mb-6" x-data="{ showInsights: false }">
                <button @click="showInsights = !showInsights" class="w-full p-4 flex items-center justify-between text-left hover:bg-slate-50 transition rounded-2xl">
                    <div class="flex items-center gap-3">
                        <i class="fas fa-lightbulb text-amber-500"></i>
                        <span class="font-semibold text-slate-900">Insights &amp; Recommendations</span>
                        <span class="text-xs px-2 py-0.5 bg-blue-100 text-blue-700 rounded-full" x-text="((results?.insights || []).length + (results?.recommendations || []).length) + ' items'"></span>
                    </div>
                    <i class="fas fa-chevron-down text-slate-400 transition-transform duration-200" :class="{ 'rotate-180': showInsights }"></i>
                </button>
                <div x-show="showInsights" x-collapse class="px-6 pb-6">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- Insights -->
                        <div>
                            <h4 class="text-sm font-semibold text-slate-700 mb-3">Insights</h4>
                            <div class="space-y-2">
                                <template x-for="insight in results?.insights || []" :key="insight.title">
                                    <div
                                        class="p-3 rounded-xl border"
                                        :class="{
                                            'bg-emerald-50 border-emerald-200': insight.type === 'opportunity',
                                            'bg-blue-50 border-blue-200': insight.type === 'trend',
                                            'bg-amber-50 border-amber-200': insight.type === 'ecommerce',
                                            'bg-pink-50 border-pink-200': insight.type === 'social',
                                            'bg-red-50 border-red-200': insight.type === 'visual'
                                        }"
                                    >
                                        <p class="text-sm font-medium text-slate-900" x-text="insight.title"></p>
                                        <p class="text-xs text-slate-600 mt-1" x-text="insight.description"></p>
                                    </div>
                                </template>
                            </div>
                        </div>
                        <!-- Recommendations -->
                        <div>
                            <h4 class="text-sm font-semibold text-slate-700 mb-3">Recommendations</h4>
                            <div class="space-y-2">
                                <template x-for="(rec, index) in results?.recommendations || []" :key="rec.platform">
                                    <div class="p-3 bg-slate-50 rounded-xl">
                                        <div class="flex items-center space-x-2 mb-1">
                                            <span class="w-5 h-5 bg-blue-600 text-white rounded-full flex items-center justify-center text-[10px] font-bold" x-text="index + 1"></span>
                                            <span class="text-sm font-semibold text-slate-900" x-text="rec.action"></span>
                                        </div>
                                        <p class="text-xs text-slate-600 mb-2" x-text="rec.description"></p>
                                        <div class="flex flex-wrap gap-1.5">
                                            <template x-for="tactic in rec.tactics" :key="tactic">
                                                <span class="text-[10px] bg-white border border-slate-200 text-slate-600 px-2 py-0.5 rounded-full" x-text="tactic"></span>
                                            </template>
                                        </div>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Keyword Details — Expandable -->
            <div class="card mb-6" x-data="{ showDetails: false }">
                <button @click="showDetails = !showDetails" class="w-full p-4 flex items-center justify-between text-left hover:bg-slate-50 transition rounded-2xl">
                    <div class="flex items-center gap-3">
                        <i class="fas fa-table text-slate-500"></i>
                        <span class="font-semibold text-slate-900">Keyword Details</span>
                        <span class="text-xs px-2 py-0.5 bg-slate-100 text-slate-600 rounded-full" x-text="Object.keys(results?.keyword_details || {}).length + ' keywords'"></span>
                    </div>
                    <div class="flex items-center gap-2">
                        <button @click.stop="exportCSV()" class="px-2 py-1 text-[10px] font-medium text-slate-500 bg-slate-100 hover:bg-slate-200 rounded-lg transition">
                            <i class="fas fa-download mr-0.5"></i> CSV
                        </button>
                        <button @click.stop="copyToClipboard()" class="px-2 py-1 text-[10px] font-medium text-slate-500 bg-slate-100 hover:bg-slate-200 rounded-lg transition">
                            <i class="fas fa-copy mr-0.5"></i> Copy
                        </button>
                        <i class="fas fa-chevron-down text-slate-400 transition-transform duration-200" :class="{ 'rotate-180': showDetails }"></i>
                    </div>
                </button>
                <div x-show="showDetails" x-collapse class="px-6 pb-6">
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead>
                                <tr class="text-left border-b border-slate-200">
                                    <th class="pb-3 pr-4 font-semibold text-slate-500">Keyword</th>
                                    <th class="pb-3 px-3 text-right font-semibold text-slate-500" title="Monthly search volume">
                                        <i class="fab fa-google text-blue-500 mr-1"></i>Google
                                    </th>
                                    <th class="pb-3 px-3 text-right font-semibold text-slate-500" title="Monthly search volume">
                                        <i class="fab fa-youtube text-red-500 mr-1"></i>YouTube
                                    </th>
                                    <th class="pb-3 px-3 text-right font-semibold text-slate-500" title="Monthly search volume">
                                        <i class="fab fa-amazon text-orange-500 mr-1"></i>Amazon
                                    </th>
                                    <th class="pb-3 px-3 text-right font-semibold text-slate-500" title="Avg. interactions per video">
                                        <i class="fab fa-tiktok text-slate-700 mr-1"></i>TikTok
                                    </th>
                                    <th class="pb-3 px-3 text-right font-semibold text-slate-500" title="Avg. interactions per post">
                                        <i class="fab fa-instagram text-pink-500 mr-1"></i>Instagram
                                    </th>
                                    <th class="pb-3 px-3 text-right font-semibold text-slate-500" title="Interest Index (0-100)">
                                        <i class="fab fa-pinterest text-red-600 mr-1"></i>Pinterest
                                    </th>
                                    <th class="pb-3 pl-3 text-center font-semibold text-slate-500">Best</th>
                                </tr>
                            </thead>
                            <tbody>
                                <template x-for="(data, keyword) in results?.keyword_details || {}" :key="keyword">
                                    <tr class="border-b border-slate-100 hover:bg-slate-50 transition">
                                        <td class="py-3 pr-4 font-medium text-slate-900" x-text="keyword"></td>
                                        <td class="py-3 px-3 text-right text-slate-600" x-text="formatNumber(data.platforms?.google?.volume || 0)"></td>
                                        <td class="py-3 px-3 text-right text-slate-600" x-text="formatNumber(data.platforms?.youtube?.volume || 0)"></td>
                                        <td class="py-3 px-3 text-right text-slate-600" x-text="formatNumber(data.platforms?.amazon?.volume || 0)"></td>
                                        <td class="py-3 px-3 text-right text-slate-600" x-text="formatNumber(data.platforms?.tiktok?.volume || 0)"></td>
                                        <td class="py-3 px-3 text-right text-slate-600" x-text="formatNumber(data.platforms?.instagram?.volume || 0)"></td>
                                        <td class="py-3 px-3 text-right text-slate-600" x-text="formatNumber(data.platforms?.pinterest?.volume || 0)"></td>
                                        <td class="py-3 pl-3 text-center">
                                            <span
                                                class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium"
                                                :class="{
                                                    'bg-blue-100 text-blue-700': data.best_platform === 'google',
                                                    'bg-red-100 text-red-700': data.best_platform === 'youtube',
                                                    'bg-orange-100 text-orange-700': data.best_platform === 'amazon',
                                                    'bg-slate-100 text-slate-700': data.best_platform === 'tiktok',
                                                    'bg-pink-100 text-pink-700': data.best_platform === 'instagram',
                                                    'bg-red-100 text-red-600': data.best_platform === 'pinterest'
                                                }"
                                                x-text="data.best_platform || '-'"
                                            ></span>
                                        </td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Q2: What is driving search interest? -->
            <div class="mt-8 mb-6">
                <h2 class="text-lg font-bold text-slate-900">
                    <span class="inline-flex items-center justify-center w-7 h-7 rounded-full bg-indigo-600 text-white text-sm font-bold mr-2">2</span>
                    What is driving search interest?
                </h2>
                <p class="text-sm text-slate-500 mt-1 ml-9">Trend momentum, seasonality, geographic hotspots, and emerging queries</p>
            </div>

            <!-- Cross-Platform Trends Intelligence Section -->
            <div class="card p-6" x-show="hasResults">
                <div class="flex items-center justify-between mb-6">
                    <div>
                        <h3 class="text-lg font-semibold text-slate-900">
                            <i class="fas fa-chart-line text-indigo-500 mr-2"></i>Trend Intelligence
                        </h3>
                        <p class="text-sm text-slate-500 mt-1">Trend momentum, seasonality, and cross-platform signals</p>
                    </div>
                    <button
                        @click="loadTrendsIntelligence()"
                        :disabled="trendsLoading"
                        class="px-4 py-2 text-sm font-medium text-blue-600 bg-blue-50 hover:bg-blue-100 rounded-lg transition disabled:opacity-50"
                    >
                        <i :class="trendsLoading ? 'fas fa-circle-notch fa-spin' : 'fas fa-chart-line'" class="mr-1"></i>
                        <span x-text="trendsLoading ? 'Loading...' : (trendsData ? 'Refresh' : 'Load Trends')"></span>
                    </button>
                </div>

                <!-- Trends Content -->
                <div x-show="trendsData" x-cloak>
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <!-- Trend Chart -->
                        <div class="lg:col-span-2">
                            <h4 class="text-sm font-semibold text-slate-700 mb-3">
                                <i class="fas fa-chart-area mr-1 text-blue-500"></i>
                                12-Month Cross-Platform Trend
                            </h4>
                            <div class="bg-slate-50 rounded-xl p-4 h-80">
                                <canvas id="trendsChart"></canvas>
                            </div>
                            <!-- Demo Data Notice -->
                            <div x-show="trendsData?.demo_platforms?.length" class="mt-3 p-2 bg-amber-50 border border-amber-200 rounded-lg">
                                <p class="text-xs text-amber-700">
                                    <i class="fas fa-flask mr-1"></i>
                                    <strong>Prototype:</strong> Dashed lines (<span x-text="(trendsData?.demo_platforms || []).map(p => p.charAt(0).toUpperCase() + p.slice(1)).join(', ')"></span>) show simulated trends based on Google Web patterns.
                                    With a KeywordTool.io API license, these would show real platform-specific search volumes.
                                </p>
                            </div>
                            <!-- Seasonality Badge -->
                            <div x-show="trendsData?.seasonality" class="mt-3 flex items-center space-x-2">
                                <span class="text-xs bg-amber-100 text-amber-700 px-2 py-1 rounded-full">
                                    <i class="fas fa-calendar-alt mr-1"></i>
                                    Peak: <span x-text="trendsData?.seasonality?.peak_month"></span>
                                </span>
                                <span class="text-xs text-slate-500">
                                    Seasonality: <span x-text="trendsData?.seasonality?.seasonality_strength" class="font-medium"></span>
                                </span>
                            </div>

                            <!-- Correlation Insight Card -->
                            <div x-show="trendsData?.correlation_analysis?.insights?.length" class="mt-4 p-4 bg-gradient-to-r from-indigo-50 to-purple-50 rounded-xl border border-indigo-200">
                                <div class="flex items-center justify-between mb-2">
                                    <h5 class="text-sm font-semibold text-indigo-800">
                                        <i class="fas fa-link mr-1"></i> Cross-Platform Correlation
                                    </h5>
                                    <span class="text-xs px-2 py-0.5 bg-indigo-100 text-indigo-600 rounded-full"
                                        x-text="(trendsData?.correlation_analysis?.method || 'pearson').replace('+', ' + ')">
                                    </span>
                                </div>
                                <template x-for="insight in (trendsData?.correlation_analysis?.insights || [])" :key="insight">
                                    <p class="text-sm text-indigo-700 mb-1" x-text="insight"></p>
                                </template>
                                <div x-show="trendsData?.correlation_analysis?.pairs?.length" class="mt-3 space-y-2">
                                    <template x-for="pair in (trendsData?.correlation_analysis?.pairs || [])" :key="pair.platform_a + pair.platform_b">
                                        <div class="flex items-center justify-between p-2 bg-white/60 rounded-lg">
                                            <span class="text-xs font-medium text-slate-700"
                                                x-text="pair.platform_a.replace('_',' ') + ' / ' + pair.platform_b.replace('_',' ')">
                                            </span>
                                            <div class="flex items-center gap-2">
                                                <span class="text-xs px-2 py-0.5 rounded-full"
                                                    :class="{
                                                        'bg-green-100 text-green-700': pair.significant && Math.abs(pair.spearman_rho || pair.correlation) > 0.4,
                                                        'bg-amber-100 text-amber-700': pair.significant && Math.abs(pair.spearman_rho || pair.correlation) <= 0.4,
                                                        'bg-slate-100 text-slate-500': !pair.significant
                                                    }"
                                                    x-text="'ρ=' + (pair.spearman_rho ?? pair.correlation) + (pair.significant ? ' *' : '')">
                                                </span>
                                                <template x-if="pair.granger_b_causes_a?.significant || pair.granger_a_causes_b?.significant">
                                                    <span class="text-xs px-2 py-0.5 bg-purple-100 text-purple-700 rounded-full font-medium">
                                                        <i class="fas fa-bolt mr-0.5"></i>Granger
                                                    </span>
                                                </template>
                                            </div>
                                        </div>
                                    </template>
                                </div>
                            </div>
                        </div>

                        <!-- Geographic Hotspots -->
                        <div>
                            <h4 class="text-sm font-semibold text-slate-700 mb-3">
                                <i class="fas fa-globe mr-1 text-green-500"></i>
                                Geographic Hotspots
                            </h4>
                            <div class="space-y-2">
                                <template x-for="(region, index) in (trendsData?.interest_by_region || []).slice(0, 8)" :key="region.region">
                                    <div class="flex items-center justify-between p-2 bg-slate-50 rounded-lg">
                                        <div class="flex items-center space-x-2">
                                            <span class="w-5 h-5 rounded-full bg-gradient-to-br from-blue-500 to-indigo-600 flex items-center justify-center text-white text-xs font-bold" x-text="index + 1"></span>
                                            <span class="text-sm text-slate-700" x-text="region.region"></span>
                                        </div>
                                        <div class="flex items-center">
                                            <div class="w-16 h-2 bg-slate-200 rounded-full overflow-hidden mr-2">
                                                <div class="h-full bg-blue-500 rounded-full" :style="'width: ' + getRegionInterest(region) + '%'"></div>
                                            </div>
                                            <span class="text-xs text-slate-500 w-8 text-right" x-text="getRegionInterest(region)"></span>
                                        </div>
                                    </div>
                                </template>
                                <p x-show="!trendsData?.interest_by_region?.length" class="text-sm text-slate-400 text-center py-4">
                                    No geographic data available
                                </p>
                            </div>
                        </div>
                    </div>

                    <!-- Rising Queries Section -->
                    <div class="mt-6 pt-6 border-t border-slate-200">
                        <h4 class="text-sm font-semibold text-slate-700 mb-3">
                            <i class="fas fa-rocket mr-1 text-pink-500"></i>
                            Rising Queries
                            <span class="text-xs font-normal text-slate-400 ml-2">Emerging search terms with high growth</span>
                        </h4>
                        <div class="flex flex-wrap gap-2">
                            <template x-for="query in (trendsData?.rising_queries || []).slice(0, 12)" :key="query.query">
                                <span
                                    class="inline-flex items-center px-3 py-1.5 rounded-full text-sm transition"
                                    :class="query.value === 'Breakout' ? 'bg-pink-100 text-pink-700 ring-1 ring-pink-300' : 'bg-slate-100 text-slate-700'"
                                >
                                    <span x-text="query.query"></span>
                                    <span
                                        class="ml-1.5 text-xs font-medium"
                                        :class="query.value === 'Breakout' ? 'text-pink-500' : 'text-green-600'"
                                        x-text="query.value === 'Breakout' ? 'Breakout' : '+' + query.value + '%'"
                                    ></span>
                                </span>
                            </template>
                            <p x-show="!trendsData?.rising_queries?.length" class="text-sm text-slate-400">
                                No rising queries detected
                            </p>
                        </div>
                    </div>

                    <!-- Trends Insights -->
                    <div x-show="trendsData?.insights?.length" class="mt-6 pt-6 border-t border-slate-200">
                        <h4 class="text-sm font-semibold text-slate-700 mb-3">
                            <i class="fas fa-lightbulb mr-1 text-amber-500"></i>
                            Trends Insights
                        </h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                            <template x-for="insight in trendsData?.insights || []" :key="insight.title">
                                <div
                                    class="p-3 rounded-xl border"
                                    :class="{
                                        'bg-green-50 border-green-200': insight.type === 'trend_up',
                                        'bg-pink-50 border-pink-200': insight.type === 'breakout',
                                        'bg-amber-50 border-amber-200': insight.type === 'seasonality',
                                        'bg-blue-50 border-blue-200': insight.type === 'geographic',
                                        'bg-red-50 border-red-200': insight.type === 'trend_down',
                                        'bg-indigo-50 border-indigo-200': insight.type === 'rising'
                                    }"
                                >
                                    <p class="text-sm font-medium text-slate-800" x-text="insight.title"></p>
                                    <p class="text-xs text-slate-600 mt-1" x-text="insight.description"></p>
                                </div>
                            </template>
                        </div>
                    </div>
                </div>

                <!-- Empty State for Trends -->
                <div x-show="!trendsData && !trendsLoading" class="text-center py-8">
                    <i class="fas fa-chart-line text-4xl text-slate-300 mb-3"></i>
                    <p class="text-slate-500 text-sm">Click "Load Trends" to fetch cross-platform trend data</p>
                    <p class="text-slate-400 text-xs mt-1">Google Web + YouTube + TikTok trends with correlation analysis</p>
                </div>
            </div>

            <!-- Search Landscape Section -->
            <div class="card p-6 mt-6" x-show="hasResults">
                <div class="flex items-center justify-between mb-4">
                    <div>
                        <h3 class="text-lg font-semibold text-slate-900">
                            <i class="fas fa-globe-americas text-indigo-500 mr-2"></i>Search Landscape
                        </h3>
                        <p class="text-sm text-slate-500 mt-1">Who owns the search results? Live Google SERP analysis.</p>
                    </div>
                    <div class="flex items-center gap-2">
                        <input
                            type="text"
                            x-model="landscapeBrand"
                            placeholder="Brand name (optional)"
                            class="px-3 py-1.5 text-xs bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500 w-40"
                        >
                        <button
                            @click="loadSearchLandscape()"
                            :disabled="landscapeLoading"
                            class="px-3 py-1.5 text-xs font-medium rounded-lg bg-indigo-600 text-white hover:bg-indigo-700 disabled:opacity-50 transition-all"
                        >
                            <i :class="landscapeLoading ? 'fas fa-circle-notch fa-spin' : 'fas fa-search'" class="mr-1"></i>
                            <span x-text="landscapeLoading ? 'Scanning...' : (landscapeData ? 'Refresh' : 'Scan SERP')"></span>
                        </button>
                    </div>
                </div>

                <!-- Loading State -->
                <div x-show="landscapeLoading" class="text-center py-8">
                    <i class="fas fa-circle-notch fa-spin text-3xl text-indigo-400 mb-3"></i>
                    <p class="text-sm text-slate-500">Scanning live Google results...</p>
                </div>

                <!-- Results -->
                <div x-show="landscapeData && !landscapeLoading">

                    <!-- Brand Position Alert -->
                    <div x-show="landscapeData?.brand" class="mb-4">
                        <div class="p-4 rounded-xl border"
                            :class="{
                                'bg-green-50 border-green-200': landscapeData?.brand_position && landscapeData?.brand_position <= 3,
                                'bg-amber-50 border-amber-200': landscapeData?.brand_position && landscapeData?.brand_position > 3 && landscapeData?.brand_position <= 10,
                                'bg-red-50 border-red-200': !landscapeData?.brand_position || landscapeData?.brand_position > 10
                            }">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 rounded-xl flex items-center justify-center font-bold text-lg"
                                    :class="{
                                        'bg-green-200 text-green-800': landscapeData?.brand_position && landscapeData?.brand_position <= 3,
                                        'bg-amber-200 text-amber-800': landscapeData?.brand_position && landscapeData?.brand_position > 3 && landscapeData?.brand_position <= 10,
                                        'bg-red-200 text-red-800': !landscapeData?.brand_position || landscapeData?.brand_position > 10
                                    }"
                                    x-text="landscapeData?.brand_position ? '#' + landscapeData.brand_position : '—'">
                                </div>
                                <div>
                                    <p class="font-semibold text-slate-900" x-text="landscapeData?.brand_position ? landscapeData.brand + ' ranks #' + landscapeData.brand_position + ' for \"' + landscapeData.keyword + '\"' : landscapeData.brand + ' not found in top 20 for \"' + landscapeData.keyword + '\"'"></p>
                                    <p class="text-xs text-slate-500 mt-0.5" x-text="landscapeData?.brand_position <= 3 ? 'Strong visibility — top 3 captures ~60% of clicks' : (landscapeData?.brand_position <= 10 ? 'Page 1 but below top 3 — losing clicks to competitors above' : 'Major visibility gap — your brand is invisible for this search')"></p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <!-- Top Domains -->
                        <div class="lg:col-span-2">
                            <h4 class="text-sm font-semibold text-slate-700 mb-3">
                                <i class="fas fa-list-ol mr-1 text-indigo-500"></i> Top Ranking Domains
                            </h4>
                            <div class="space-y-1.5">
                                <template x-for="result in (landscapeData?.organic_results || [])" :key="result.position">
                                    <div class="flex items-center gap-3 p-2 rounded-lg transition"
                                        :class="result.is_brand ? 'bg-blue-50 border border-blue-200' : 'hover:bg-slate-50'">
                                        <span class="w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold flex-shrink-0"
                                            :class="{
                                                'bg-yellow-200 text-yellow-800': result.position <= 3,
                                                'bg-slate-200 text-slate-600': result.position > 3
                                            }"
                                            x-text="result.position">
                                        </span>
                                        <div class="flex-1 min-w-0">
                                            <div class="flex items-center gap-2">
                                                <span class="text-sm font-medium text-slate-800 truncate" x-text="result.domain"></span>
                                                <span class="text-[9px] px-1.5 py-0.5 rounded-full font-medium flex-shrink-0"
                                                    :class="{
                                                        'bg-blue-100 text-blue-700': result.type === 'brand',
                                                        'bg-orange-100 text-orange-700': result.type === 'marketplace',
                                                        'bg-purple-100 text-purple-700': result.type === 'content',
                                                        'bg-green-100 text-green-700': result.type === 'retailer',
                                                        'bg-pink-100 text-pink-700': result.type === 'social'
                                                    }"
                                                    x-text="result.type">
                                                </span>
                                                <span x-show="result.is_brand" class="text-[9px] px-1.5 py-0.5 rounded-full bg-blue-600 text-white font-bold flex-shrink-0">YOUR BRAND</span>
                                            </div>
                                            <p class="text-[11px] text-slate-400 truncate" x-text="result.title"></p>
                                        </div>
                                    </div>
                                </template>
                            </div>
                        </div>

                        <!-- Right Column: Type Breakdown + People Also Ask -->
                        <div>
                            <!-- SERP Composition -->
                            <h4 class="text-sm font-semibold text-slate-700 mb-3">
                                <i class="fas fa-chart-pie mr-1 text-indigo-500"></i> SERP Composition
                            </h4>
                            <div class="space-y-2 mb-6">
                                <template x-for="tb in (landscapeData?.type_breakdown || [])" :key="tb.type">
                                    <div>
                                        <div class="flex justify-between text-xs mb-1">
                                            <span class="font-medium text-slate-600" x-text="tb.label"></span>
                                            <span class="text-slate-500" x-text="tb.count + ' (' + tb.percentage + '%)'"></span>
                                        </div>
                                        <div class="h-2 bg-slate-100 rounded-full overflow-hidden">
                                            <div class="h-full rounded-full"
                                                :class="{
                                                    'bg-blue-500': tb.type === 'brand',
                                                    'bg-orange-500': tb.type === 'marketplace',
                                                    'bg-purple-500': tb.type === 'content',
                                                    'bg-green-500': tb.type === 'retailer',
                                                    'bg-pink-500': tb.type === 'social'
                                                }"
                                                :style="'width: ' + Math.max(tb.percentage, 3) + '%'">
                                            </div>
                                        </div>
                                    </div>
                                </template>
                            </div>

                            <!-- People Also Ask -->
                            <div x-show="landscapeData?.people_also_ask?.length">
                                <h4 class="text-sm font-semibold text-slate-700 mb-3">
                                    <i class="fas fa-question-circle mr-1 text-amber-500"></i> People Also Ask
                                </h4>
                                <div class="space-y-1.5">
                                    <template x-for="paa in (landscapeData?.people_also_ask || [])" :key="paa.question">
                                        <div class="p-2 bg-slate-50 rounded-lg">
                                            <p class="text-xs text-slate-700" x-text="paa.question"></p>
                                            <p class="text-[10px] text-slate-400 mt-0.5" x-text="paa.domain"></p>
                                        </div>
                                    </template>
                                </div>
                            </div>

                            <!-- SERP Features -->
                            <div x-show="landscapeData?.serp_features?.length" class="mt-4">
                                <h4 class="text-sm font-semibold text-slate-700 mb-2">
                                    <i class="fas fa-star mr-1 text-yellow-500"></i> SERP Features
                                </h4>
                                <div class="flex flex-wrap gap-1.5">
                                    <template x-for="sf in (landscapeData?.serp_features || [])" :key="sf.type + (sf.domain || '')">
                                        <span class="text-[10px] px-2 py-1 rounded-full bg-yellow-50 border border-yellow-200 text-yellow-700"
                                            x-text="sf.type.replace('_', ' ')">
                                        </span>
                                    </template>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Landscape Insights -->
                    <div x-show="landscapeData?.insights?.length" class="mt-4 pt-4 border-t border-slate-200">
                        <h4 class="text-sm font-semibold text-slate-700 mb-3">
                            <i class="fas fa-lightbulb mr-1 text-amber-500"></i> Landscape Insights
                        </h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
                            <template x-for="insight in (landscapeData?.insights || [])" :key="insight.title">
                                <div class="p-3 rounded-xl border"
                                    :class="{
                                        'bg-green-50 border-green-200': insight.type === 'positive',
                                        'bg-amber-50 border-amber-200': insight.type === 'warning',
                                        'bg-red-50 border-red-200': insight.type === 'negative',
                                        'bg-blue-50 border-blue-200': insight.type === 'info',
                                        'bg-emerald-50 border-emerald-200': insight.type === 'opportunity'
                                    }">
                                    <p class="text-xs font-semibold text-slate-800" x-text="insight.title"></p>
                                    <p class="text-[11px] text-slate-600 mt-1" x-text="insight.description"></p>
                                </div>
                            </template>
                        </div>
                    </div>
                </div>

                <!-- Empty State -->
                <div x-show="!landscapeData && !landscapeLoading" class="text-center py-6">
                    <i class="fas fa-globe-americas text-3xl text-slate-300 mb-2"></i>
                    <p class="text-sm text-slate-400">Click "Scan SERP" to see who owns the search results for your keyword.</p>
                    <p class="text-xs text-slate-300 mt-1">Enter a brand name to check if it appears in the results.</p>
                </div>
            </div>

            <!-- Q3: What can we learn from search behavior? -->
            <div class="mt-8 mb-6">
                <h2 class="text-lg font-bold text-slate-900">
                    <span class="inline-flex items-center justify-center w-7 h-7 rounded-full bg-violet-600 text-white text-sm font-bold mr-2">3</span>
                    What can we learn from search behavior?
                </h2>
                <p class="text-sm text-slate-500 mt-1 ml-9">Funnel stage analysis, share of search, and behavioral modifier signals</p>
            </div>

            <!-- Behavioral Intelligence Section -->
            <div class="card p-6" x-show="hasResults">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold text-slate-900">
                        <i class="fas fa-brain text-violet-500 mr-2"></i>Search Behavior Insights
                    </h3>
                    <button
                        @click="loadBehavioralAnalysis()"
                        :disabled="behavioralLoading"
                        class="px-3 py-1.5 text-xs font-medium rounded-lg bg-violet-600 text-white hover:bg-violet-700 disabled:opacity-50 transition-all">
                        <i :class="behavioralLoading ? 'fas fa-circle-notch fa-spin' : 'fas fa-microscope'" class="mr-1"></i>
                        <span x-text="behavioralLoading ? 'Analyzing...' : (behavioralData ? 'Refresh' : 'Analyze Behavior')"></span>
                    </button>
                </div>

                <!-- Loading State -->
                <div x-show="behavioralLoading" class="text-center py-8">
                    <i class="fas fa-circle-notch fa-spin text-3xl text-violet-400 mb-3"></i>
                    <p class="text-sm text-slate-500">Analyzing funnel stages, behavioral modifiers, and market patterns...</p>
                </div>

                <!-- Results -->
                <div x-show="behavioralData && !behavioralLoading">

                    <!-- Funnel Stage Mapping -->
                    <div x-show="behavioralData?.funnel_analysis" class="mb-6">
                        <h4 class="text-sm font-semibold text-slate-700 mb-3">
                            <i class="fas fa-filter text-blue-500 mr-1"></i>
                            Category Funnel Profile
                        </h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="h-48">
                                <canvas id="funnelChart"></canvas>
                            </div>
                            <div>
                                <div class="space-y-2 mb-3">
                                    <template x-for="stage in (behavioralData?.funnel_analysis?.stages || [])" :key="stage.stage">
                                        <div class="flex items-center justify-between p-2 rounded-lg"
                                            :class="{
                                                'bg-blue-50': stage.stage === 'awareness',
                                                'bg-amber-50': stage.stage === 'consideration',
                                                'bg-emerald-50': stage.stage === 'purchase'
                                            }">
                                            <div class="flex items-center gap-2">
                                                <div class="w-2.5 h-2.5 rounded-full"
                                                    :class="{
                                                        'bg-blue-500': stage.stage === 'awareness',
                                                        'bg-amber-500': stage.stage === 'consideration',
                                                        'bg-emerald-500': stage.stage === 'purchase'
                                                    }"></div>
                                                <span class="text-xs font-medium text-slate-700 capitalize" x-text="stage.stage"></span>
                                            </div>
                                            <div class="flex items-center gap-2">
                                                <span class="text-xs font-bold" x-text="stage.percentage + '%'"></span>
                                                <span class="text-[10px] text-slate-400" x-text="stage.volume.toLocaleString() + ' vol'"></span>
                                            </div>
                                        </div>
                                    </template>
                                </div>
                                <div class="p-3 bg-violet-50 rounded-lg border border-violet-200">
                                    <p class="text-xs text-violet-800" x-text="behavioralData?.funnel_analysis?.insight"></p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Share of Search -->
                    <div x-show="behavioralData?.share_of_search" class="mb-6">
                        <h4 class="text-sm font-semibold text-slate-700 mb-3">
                            <i class="fas fa-chart-pie text-green-500 mr-1"></i>
                            Share of Search
                            <span class="text-[10px] font-normal text-slate-400 ml-1">(Les Binet method — predicts market share)</span>
                        </h4>
                        <div class="space-y-2">
                            <template x-for="brand in (behavioralData?.share_of_search?.brands || [])" :key="brand.brand">
                                <div class="relative overflow-hidden rounded-lg bg-slate-50 p-3">
                                    <div class="absolute inset-y-0 left-0 bg-gradient-to-r from-green-100 to-green-50 rounded-lg"
                                        :style="'width:' + Math.min(brand.share_percentage, 100) + '%'"></div>
                                    <div class="relative flex items-center justify-between">
                                        <span class="text-sm font-medium text-slate-800 capitalize" x-text="brand.brand"></span>
                                        <div class="flex items-center gap-3">
                                            <span class="text-xs text-slate-500" x-text="brand.volume.toLocaleString() + '/mo'"></span>
                                            <span class="text-sm font-bold text-slate-900" x-text="brand.share_percentage.toFixed(1) + '%'"></span>
                                        </div>
                                    </div>
                                </div>
                            </template>
                        </div>
                        <div class="mt-2 flex justify-between text-xs text-slate-500">
                            <span x-text="'Unbranded: ' + (behavioralData?.share_of_search?.unbranded_percentage || 0).toFixed(1) + '%'"></span>
                            <span x-text="'Total category: ' + (behavioralData?.share_of_search?.total_category_volume || 0).toLocaleString() + '/mo'"></span>
                        </div>
                        <div x-show="behavioralData?.share_of_search?.insight" class="mt-2 p-3 bg-green-50 rounded-lg border border-green-200">
                            <p class="text-xs text-green-800" x-text="behavioralData?.share_of_search?.insight"></p>
                        </div>
                    </div>

                    <!-- Behavioral Modifiers -->
                    <div x-show="behavioralData?.behavioral_modifiers?.pairs?.length">
                        <h4 class="text-sm font-semibold text-slate-700 mb-3">
                            <i class="fas fa-arrows-alt-h text-orange-500 mr-1"></i>
                            Market Behavior Signals
                        </h4>
                        <div class="space-y-3">
                            <template x-for="pair in (behavioralData?.behavioral_modifiers?.pairs || [])" :key="pair.modifier_a + pair.modifier_b">
                                <div class="p-3 bg-slate-50 rounded-lg">
                                    <div class="flex items-center justify-between mb-2">
                                        <span class="text-xs font-medium text-slate-600" x-text="pair.label"></span>
                                        <span class="text-xs px-2 py-0.5 rounded-full font-medium"
                                            :class="{
                                                'bg-blue-100 text-blue-700': pair.ratio > 2,
                                                'bg-amber-100 text-amber-700': pair.ratio >= 0.5 && pair.ratio <= 2,
                                                'bg-red-100 text-red-700': pair.ratio < 0.5
                                            }"
                                            x-text="pair.ratio.toFixed(1) + 'x'"></span>
                                    </div>
                                    <div class="flex items-center gap-2 mb-2">
                                        <div class="flex-1">
                                            <div class="flex justify-between text-[10px] text-slate-500 mb-1">
                                                <span x-text="'\"' + pair.modifier_a + '\"'"></span>
                                                <span x-text="pair.volume_a.toLocaleString()"></span>
                                            </div>
                                            <div class="h-1.5 bg-slate-200 rounded-full overflow-hidden">
                                                <div class="h-full bg-red-400 rounded-full"
                                                    :style="'width:' + Math.min(pair.volume_a / Math.max(pair.volume_a, pair.volume_b) * 100, 100) + '%'"></div>
                                            </div>
                                        </div>
                                        <span class="text-[10px] text-slate-400 font-medium">vs</span>
                                        <div class="flex-1">
                                            <div class="flex justify-between text-[10px] text-slate-500 mb-1">
                                                <span x-text="'\"' + pair.modifier_b + '\"'"></span>
                                                <span x-text="pair.volume_b.toLocaleString()"></span>
                                            </div>
                                            <div class="h-1.5 bg-slate-200 rounded-full overflow-hidden">
                                                <div class="h-full bg-blue-400 rounded-full"
                                                    :style="'width:' + Math.min(pair.volume_b / Math.max(pair.volume_a, pair.volume_b) * 100, 100) + '%'"></div>
                                            </div>
                                        </div>
                                    </div>
                                    <p class="text-[11px] text-slate-600" x-text="pair.insight"></p>
                                </div>
                            </template>
                        </div>
                    </div>

                </div>

                <!-- Empty state for behavioral -->
                <div x-show="!behavioralData && !behavioralLoading" class="text-center py-6">
                    <i class="fas fa-brain text-3xl text-slate-300 mb-2"></i>
                    <p class="text-sm text-slate-400">Click "Analyze Behavior" to discover funnel insights, share of search, and behavioral patterns.</p>
                </div>
            </div>

            <!-- FAQ — collapsed at bottom -->
            <div class="card mt-8" x-data="{ openFaq: null, showFaq: false }">
                <button @click="showFaq = !showFaq" class="w-full p-4 flex items-center justify-between text-left hover:bg-slate-50 transition rounded-2xl">
                    <div class="flex items-center gap-3">
                        <i class="fas fa-question-circle text-slate-400"></i>
                        <span class="text-sm font-medium text-slate-500">Methodology &amp; FAQ</span>
                    </div>
                    <i class="fas fa-chevron-down text-slate-300 transition-transform duration-200" :class="{ 'rotate-180': showFaq }"></i>
                </button>
                <div x-show="showFaq" x-collapse class="px-6 pb-6 space-y-2">
                    <div class="border border-slate-200 rounded-lg overflow-hidden">
                        <button @click="openFaq = openFaq === 1 ? null : 1" class="w-full flex items-center justify-between p-3 text-left hover:bg-slate-50 transition">
                            <span class="text-sm font-medium text-slate-700">What is Total Search?</span>
                            <i class="fas fa-chevron-down text-slate-400 text-xs transition-transform duration-200" :class="{ 'rotate-180': openFaq === 1 }"></i>
                        </button>
                        <div x-show="openFaq === 1" x-collapse class="px-3 pb-3 text-xs text-slate-600">
                            <p>Total Search measures search demand across 6 platforms: Google, YouTube, Amazon, TikTok, Instagram, and Pinterest. Each platform reveals demand through a different signal — search queries, video engagement, visual discovery.</p>
                        </div>
                    </div>
                    <div class="border border-slate-200 rounded-lg overflow-hidden">
                        <button @click="openFaq = openFaq === 2 ? null : 2" class="w-full flex items-center justify-between p-3 text-left hover:bg-slate-50 transition">
                            <span class="text-sm font-medium text-slate-700">How is volume share calculated?</span>
                            <i class="fas fa-chevron-down text-slate-400 text-xs transition-transform duration-200" :class="{ 'rotate-180': openFaq === 2 }"></i>
                        </button>
                        <div x-show="openFaq === 2" x-collapse class="px-3 pb-3 text-xs text-slate-600">
                            <p>Each platform's raw volume is divided by the total across all platforms. A platform with 60%+ share is the dominant channel.</p>
                        </div>
                    </div>
                    <div class="border border-slate-200 rounded-lg overflow-hidden">
                        <button @click="openFaq = openFaq === 3 ? null : 3" class="w-full flex items-center justify-between p-3 text-left hover:bg-slate-50 transition">
                            <span class="text-sm font-medium text-slate-700">How is demand measured on each platform?</span>
                            <i class="fas fa-chevron-down text-slate-400 text-xs transition-transform duration-200" :class="{ 'rotate-180': openFaq === 3 }"></i>
                        </button>
                        <div x-show="openFaq === 3" x-collapse class="px-3 pb-3 text-xs text-slate-600">
                            <p><strong>Google, YouTube, Amazon</strong> — monthly search volume (DataForSEO). <strong>TikTok, Instagram</strong> — avg. interactions per post (Apify). <strong>Pinterest</strong> — interest index 0-100 (Pinterest Trends).</p>
                        </div>
                    </div>
                    <div class="border border-slate-200 rounded-lg overflow-hidden">
                        <button @click="openFaq = openFaq === 4 ? null : 4" class="w-full flex items-center justify-between p-3 text-left hover:bg-slate-50 transition">
                            <span class="text-sm font-medium text-slate-700">What do Audience Profiles do?</span>
                            <i class="fas fa-chevron-down text-slate-400 text-xs transition-transform duration-200" :class="{ 'rotate-180': openFaq === 4 }"></i>
                        </button>
                        <div x-show="openFaq === 4" x-collapse class="px-3 pb-3 text-xs text-slate-600">
                            <p>Audience Profiles adjust how platforms are ranked in insights. For example, "E-commerce" weights Amazon higher. Profiles are calibrated using NP Digital, Jungle Scout, McKinsey, and Adobe research data.</p>
                        </div>
                    </div>
                </div>
            </div>

        </div>

        <!-- Empty State -->
        <div x-show="!hasResults && !isLoading" class="text-center py-20">
            <div class="inline-block p-8 bg-white rounded-2xl shadow-sm mb-6">
                <i class="fas fa-chart-pie text-6xl text-slate-300"></i>
            </div>
            <h2 class="text-2xl font-bold text-slate-900 mb-2">Total Search Intelligence</h2>
            <p class="text-slate-500 max-w-md mx-auto">
                Enter keywords above to discover: <strong>where</strong> your audience searches, <strong>what</strong> drives their interest, and <strong>what</strong> their behavior reveals.
            </p>
            <div class="flex justify-center gap-6 mt-6 text-sm text-slate-400">
                <span><span class="inline-flex items-center justify-center w-5 h-5 rounded-full bg-blue-100 text-blue-600 text-xs font-bold mr-1">1</span> Where</span>
                <span><span class="inline-flex items-center justify-center w-5 h-5 rounded-full bg-indigo-100 text-indigo-600 text-xs font-bold mr-1">2</span> What drives</span>
                <span><span class="inline-flex items-center justify-center w-5 h-5 rounded-full bg-violet-100 text-violet-600 text-xs font-bold mr-1">3</span> Behavior</span>
            </div>
        </div>

        <!-- Loading State -->
        <div x-show="isLoading" class="text-center py-20">
            <div class="inline-block p-8 bg-white rounded-2xl shadow-sm mb-6">
                <i class="fas fa-circle-notch fa-spin text-6xl text-blue-500"></i>
            </div>
            <h2 class="text-2xl font-bold text-slate-900 mb-2">Analyzing Demand...</h2>
            <p class="text-slate-500">Fetching data from 6 platforms. This may take 15-30 seconds.</p>
        </div>
    </main>

    <!-- Footer -->
    <footer class="border-t border-slate-200 mt-16 py-8 bg-white">
        <div class="max-w-6xl mx-auto px-6 text-center">
            <p class="text-slate-600 font-medium">Total Search</p>
            <p class="text-slate-400 text-sm mt-1">Cross-Platform Search Intelligence</p>
            <p class="text-slate-300 text-xs mt-4">Data: Google (DataForSEO) | YouTube (Google Trends / Estimate) | Amazon (DataForSEO) | TikTok/Instagram (Apify) | Pinterest (Trends)</p>
        </div>
    </footer>

    <script>
        function demandDashboard() {
            return {
                searchQuery: '',
                selectedCountry: 'us',
                selectedLanguage: 'en',
                selectedProfile: 'general',
                forceRefresh: false,
                isLoading: false,
                results: null,
                chart: null,
                trendsData: null,
                trendsLoading: false,
                trendsChart: null,
                behavioralData: null,
                behavioralLoading: false,
                landscapeData: null,
                landscapeLoading: false,
                landscapeBrand: '',

                get hasResults() {
                    return this.results && this.results.total_demand > 0;
                },

                getCountryName() {
                    const countries = {
                        'us': 'United States',
                        'de': 'Germany',
                        'uk': 'United Kingdom',
                        'fr': 'France',
                        'es': 'Spain',
                        'it': 'Italy',
                        'nl': 'Netherlands',
                        'au': 'Australia',
                        'ca': 'Canada',
                        'br': 'Brazil',
                        'mx': 'Mexico',
                        'jp': 'Japan'
                    };
                    return countries[this.selectedCountry] || this.selectedCountry;
                },

                getTotalVolume() {
                    return (this.results?.platforms || []).reduce((sum, p) => sum + (p.volume || 0), 0);
                },

                getPlatformVolumeShare(platform) {
                    const total = this.getTotalVolume();
                    if (total === 0) return '0.0';
                    return ((platform.volume / total) * 100).toFixed(1);
                },

                getTopPlatformShare() {
                    const top = this.getTopPlatform();
                    if (!top) return '0';
                    const total = this.getTotalVolume();
                    if (total === 0) return '0';
                    return ((top.volume / total) * 100).toFixed(1);
                },

                getTopPlatform() {
                    if (!this.results?.platforms?.length) return null;
                    return this.results.platforms.reduce((max, p) => p.volume > (max?.volume || 0) ? p : max, null);
                },

                getPlatformByName(name) {
                    return (this.results?.platforms || []).find(p => p.platform === name);
                },

                hasDataQualityIssue() {
                    if (!this.results?.platforms) return false;
                    const youtube = this.results.platforms.find(p => p.platform === 'youtube');
                    const amazon = this.results.platforms.find(p => p.platform === 'amazon');
                    return (youtube?.volume === 0) || (amazon?.volume === 0);
                },

                getExecSummaryQ2() {
                    if (!this.trendsData && !this.landscapeData) return 'Loading trend and landscape data...';
                    const parts = [];
                    if (this.trendsData?.seasonality?.seasonality_strength === 'high') {
                        parts.push('Seasonal peak in ' + this.trendsData.seasonality.peak_month + '.');
                    } else if (this.trendsData?.overall_trend) {
                        parts.push('Trend is ' + this.trendsData.overall_trend + '.');
                    }
                    if (this.landscapeData?.brand && this.landscapeData?.brand_position) {
                        parts.push(this.landscapeData.brand + ' ranks #' + this.landscapeData.brand_position + ' in Google.');
                    } else if (this.landscapeData?.brand && !this.landscapeData?.brand_position) {
                        parts.push(this.landscapeData.brand + ' not found in top 20 Google results.');
                    }
                    const rising = (this.trendsData?.rising_queries || []).filter(q => q.value === 'Breakout').length;
                    if (rising > 0) parts.push(rising + ' breakout queries detected.');
                    return parts.length ? parts.join(' ') : 'Trend and competitive data loading...';
                },

                getExecSummaryQ3() {
                    if (!this.behavioralData) return 'Loading behavioral analysis...';
                    const parts = [];
                    const funnel = this.behavioralData?.funnel_analysis?.stages || [];
                    const dominant = funnel.reduce((max, s) => s.percentage > (max?.percentage || 0) ? s : max, null);
                    if (dominant) {
                        parts.push(dominant.percentage + '% of searches are ' + dominant.stage + '-stage.');
                    }
                    const sos = this.behavioralData?.share_of_search?.brands?.[0];
                    if (sos) {
                        parts.push(sos.brand + ' leads share of search at ' + sos.share_percentage.toFixed(1) + '%.');
                    }
                    return parts.length ? parts.join(' ') : 'Behavioral data loading...';
                },

                async analyzeKeywords() {
                    if (!this.searchQuery.trim()) return;

                    this.isLoading = true;
                    this.results = null;
                    this.trendsData = null;
                    this.landscapeData = null;
                    this.behavioralData = null;

                    try {
                        const params = new URLSearchParams({
                            keywords: this.searchQuery,
                            country: this.selectedCountry,
                            language: this.selectedLanguage,
                            weight_preset: this.selectedProfile,
                            refresh: this.forceRefresh ? 'true' : 'false'
                        });

                        const response = await fetch(`/api/demand/analyze?${params}`);
                        const data = await response.json();

                        if (response.ok) {
                            this.results = data;
                            // Double nextTick + requestAnimationFrame to ensure x-show has
                            // made the canvas visible before Chart.js measures dimensions
                            this.$nextTick(() => {
                                requestAnimationFrame(() => this.renderChart());
                            });
                            // Auto-load Q2 (trends + landscape) and Q3 (behavioral) after main analysis
                            this.$nextTick(() => {
                                this.loadTrendsIntelligence();
                                this.loadSearchLandscape();
                                this.loadBehavioralAnalysis();
                            });
                        } else {
                            alert('Error: ' + (data.detail || 'Analysis failed'));
                        }
                    } catch (error) {
                        console.error('Error:', error);
                        alert('Failed to analyze keywords. Please try again.');
                    } finally {
                        this.isLoading = false;
                    }
                },

                renderChart() {
                    const ctx = document.getElementById('distributionChart');
                    if (!ctx) return;

                    if (this.chart) {
                        this.chart.destroy();
                    }

                    // Show ALL platforms with volume > 0 (volume-based share)
                    const platforms = (this.results?.platforms || []).filter(p => p.volume > 0);
                    const totalVol = platforms.reduce((sum, p) => sum + p.volume, 0);

                    this.chart = new Chart(ctx, {
                        type: 'doughnut',
                        data: {
                            labels: platforms.map(p => p.display_name),
                            datasets: [{
                                data: platforms.map(p => p.volume),
                                backgroundColor: platforms.map(p => p.color),
                                borderWidth: 0,
                                borderRadius: 4,
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: true,
                            plugins: {
                                legend: { display: false },
                                tooltip: {
                                    backgroundColor: 'white',
                                    titleColor: '#1e293b',
                                    bodyColor: '#475569',
                                    borderColor: '#e2e8f0',
                                    borderWidth: 1,
                                    cornerRadius: 8,
                                    padding: 12,
                                    callbacks: {
                                        label: (context) => {
                                            const idx = context.dataIndex;
                                            const p = platforms[idx];
                                            const vol = this.formatNumber(p.volume);
                                            const pct = totalVol > 0 ? ((p.volume / totalVol) * 100).toFixed(1) : '0';
                                            return `${context.label}: ${vol} (${pct}%)`;
                                        }
                                    }
                                }
                            },
                            cutout: '70%',
                        }
                    });
                },

                formatNumber(num) {
                    if (num >= 1000000) {
                        return (num / 1000000).toFixed(1) + 'M';
                    } else if (num >= 1000) {
                        return (num / 1000).toFixed(1) + 'K';
                    }
                    return num?.toLocaleString() || '0';
                },

                exportCSV() {
                    if (!this.results) return;
                    const profileLabel = this.results.weight_preset_label || 'General';
                    const headers = ['Keyword', 'Google (searches)', 'YouTube (searches)', 'Amazon (searches)', 'TikTok (avg interactions)', 'Instagram (avg interactions)', 'Pinterest (interest 0-100)', 'Best Platform'];
                    const rows = [`# Audience Profile: ${profileLabel}`, headers.join(',')];
                    for (const [keyword, data] of Object.entries(this.results.keyword_details || {})) {
                        const row = [
                            `"${keyword}"`,
                            data.platforms?.google?.volume || 0,
                            data.platforms?.youtube?.volume || 0,
                            data.platforms?.amazon?.volume || 0,
                            data.platforms?.tiktok?.volume || 0,
                            data.platforms?.instagram?.volume || 0,
                            data.platforms?.pinterest?.volume || 0,
                            data.best_platform || ''
                        ];
                        rows.push(row.join(','));
                    }
                    const csv = rows.join('\n');
                    const blob = new Blob([csv], { type: 'text/csv' });
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'total_search_analysis.csv';
                    a.click();
                },

                copyToClipboard() {
                    if (!this.results) return;
                    const platforms = (this.results.platforms || []).filter(p => p.volume > 0);

                    const profileLabel = this.results.weight_preset_label || 'General';
                    const totalVol = this.getTotalVolume();
                    const summary = `Total Search Analysis (${this.getCountryName()})
============================
Audience Profile: ${profileLabel}
Total Search Volume: ${this.formatNumber(totalVol)} monthly

Platform Volume Share:
${platforms.map(p => {
    const pct = totalVol > 0 ? ((p.volume / totalVol) * 100).toFixed(1) : '0';
    return `  - ${p.display_name}: ${this.formatNumber(p.volume)} (${pct}%)`;
}).join('\n')}

Top Platform: ${this.results.distribution_summary?.top_platform_name || '-'} (${this.getTopPlatformShare()}% of volume)

Generated by Total Search — Cross-Platform Search Intelligence`;
                    navigator.clipboard.writeText(summary).then(() => {
                        alert('Summary copied to clipboard!');
                    });
                },

                exportPDF() {
                    if (!this.searchQuery.trim()) return;
                    const params = new URLSearchParams({
                        keywords: this.searchQuery,
                        title: 'Search Distribution Analysis',
                        country: this.selectedCountry
                    });
                    window.open(`/api/export/pdf?${params}`, '_blank');
                },

                exportPPTX() {
                    if (!this.searchQuery.trim()) return;
                    const params = new URLSearchParams({
                        keywords: this.searchQuery,
                        title: 'Search Distribution Analysis',
                        country: this.selectedCountry
                    });
                    window.open(`/api/export/pptx?${params}`, '_blank');
                },

                async loadTrendsIntelligence() {
                    if (!this.searchQuery.trim()) return;

                    this.trendsLoading = true;

                    try {
                        const params = new URLSearchParams({
                            keywords: this.searchQuery,
                            country: this.selectedCountry.toUpperCase(),
                            timeframe: 'today 12-m'
                        });

                        const response = await fetch(`/api/trends/intelligence?${params}`);
                        const data = await response.json();

                        if (response.ok) {
                            this.trendsData = data;
                            this.$nextTick(() => this.renderTrendsChart());
                        } else {
                            console.error('Trends error:', data);
                            alert('Error loading trends: ' + (data.detail || 'Failed to fetch trends'));
                        }
                    } catch (error) {
                        console.error('Trends fetch error:', error);
                        alert('Failed to load Google Trends data. Please try again.');
                    } finally {
                        this.trendsLoading = false;
                    }
                },

                async loadBehavioralAnalysis(brands = '') {
                    if (!this.searchQuery.trim()) return;
                    this.behavioralLoading = true;

                    try {
                        const keyword = this.searchQuery.split(',')[0].trim();
                        const params = new URLSearchParams({
                            keyword,
                            country: this.selectedCountry,
                            language: this.selectedLanguage,
                        });
                        if (brands) params.set('brands', brands);

                        const response = await fetch(`/api/behavioral/analysis?${params}`);
                        const data = await response.json();

                        if (response.ok) {
                            this.behavioralData = data;
                            this.$nextTick(() => this.renderFunnelChart());
                        } else {
                            console.error('Behavioral analysis error:', data);
                            alert('Behavioral analysis error: ' + (data.detail || 'Unknown error'));
                        }
                    } catch (error) {
                        console.error('Behavioral fetch error:', error);
                        alert('Failed to load behavioral analysis: ' + error.message);
                    } finally {
                        this.behavioralLoading = false;
                    }
                },

                async loadSearchLandscape() {
                    if (!this.searchQuery.trim()) return;
                    this.landscapeLoading = true;

                    try {
                        const keyword = this.searchQuery.split(',')[0].trim();
                        const params = new URLSearchParams({
                            keyword,
                            country: this.selectedCountry,
                            language: this.selectedLanguage,
                        });
                        if (this.landscapeBrand.trim()) {
                            params.set('brand', this.landscapeBrand.trim());
                        }

                        const response = await fetch(`/api/search-landscape?${params}`);
                        const data = await response.json();

                        if (response.ok) {
                            this.landscapeData = data;
                        } else {
                            console.error('Search landscape error:', data);
                            alert('Search landscape error: ' + (data.detail || 'Unknown error'));
                        }
                    } catch (error) {
                        console.error('Search landscape fetch error:', error);
                        alert('Failed to load search landscape: ' + error.message);
                    } finally {
                        this.landscapeLoading = false;
                    }
                },

                renderFunnelChart() {
                    const ctx = document.getElementById('funnelChart');
                    if (!ctx || !this.behavioralData?.funnel_analysis) return;

                    if (this._funnelChart) this._funnelChart.destroy();

                    const stages = this.behavioralData.funnel_analysis.stages;
                    const colors = {
                        awareness: { bg: 'rgba(59, 130, 246, 0.7)', border: '#3b82f6' },
                        consideration: { bg: 'rgba(245, 158, 11, 0.7)', border: '#f59e0b' },
                        purchase: { bg: 'rgba(16, 185, 129, 0.7)', border: '#10b981' },
                    };

                    this._funnelChart = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: stages.map(s => s.stage.charAt(0).toUpperCase() + s.stage.slice(1)),
                            datasets: [{
                                data: stages.map(s => s.percentage),
                                backgroundColor: stages.map(s => colors[s.stage]?.bg || '#94a3b8'),
                                borderColor: stages.map(s => colors[s.stage]?.border || '#64748b'),
                                borderWidth: 2,
                                borderRadius: 8,
                            }],
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { legend: { display: false } },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    max: 100,
                                    ticks: { callback: v => v + '%' },
                                    grid: { color: '#f1f5f9' },
                                },
                                x: { grid: { display: false } },
                            },
                        },
                    });
                },

                renderTrendsChart() {
                    const ctx = document.getElementById('trendsChart');
                    if (!ctx || !this.trendsData?.interest_over_time) return;

                    if (this.trendsChart) {
                        this.trendsChart.destroy();
                    }

                    const datasets = [];
                    let labels = [];

                    const mp = this.trendsData.multi_platform_trends;
                    const primaryKw = (this.trendsData.keywords || [])[0] || '';
                    const demoPlatforms = this.trendsData.demo_platforms || [];

                    // Multi-platform mode: render Google Web + YouTube + Amazon + TikTok + Instagram
                    if (mp && Object.keys(mp).length > 0) {
                        const platformConfig = {
                            google_web: { label: 'Google Web',  color: '#3b82f6', dash: [] },
                            youtube:    { label: 'YouTube',     color: '#ef4444', dash: [] },
                            amazon:     { label: 'Amazon',      color: '#f59e0b', dash: [] },
                            tiktok:     { label: 'TikTok',      color: '#000000', dash: [5, 5] },
                            instagram:  { label: 'Instagram',   color: '#e1306c', dash: [5, 5] },
                        };

                        // Use google_web labels as primary timeline
                        const webData = mp.google_web?.interest_over_time || [];
                        if (webData.length) {
                            labels = webData.map(d => {
                                const date = new Date(d.date);
                                return date.toLocaleDateString('en-US', { month: 'short', year: '2-digit' });
                            });
                        }

                        for (const [platform, config] of Object.entries(platformConfig)) {
                            const platData = mp[platform]?.interest_over_time;
                            if (!platData || !platData.length) continue;

                            // Demo platforms use platform name as key; real ones use keyword
                            const key = ['tiktok', 'amazon', 'instagram'].includes(platform) ? platform : primaryKw;
                            const values = platData.map(d => d[key] || 0);

                            // If this platform has different length, use its own labels
                            if (!labels.length) {
                                labels = platData.map(d => {
                                    const date = new Date(d.date);
                                    return date.toLocaleDateString('en-US', { month: 'short', year: '2-digit' });
                                });
                            }

                            // Add (Demo) suffix for simulated data
                            const isDemo = demoPlatforms.includes(platform);
                            const label = isDemo ? `${config.label} (Demo)` : config.label;

                            datasets.push({
                                label: label,
                                data: values,
                                borderColor: config.color,
                                backgroundColor: config.color + '15',
                                borderDash: isDemo ? [5, 5] : config.dash,
                                fill: false,
                                tension: 0.4,
                                pointRadius: 0,
                                pointHoverRadius: 5,
                                borderWidth: isDemo ? 1.5 : 2.5,
                            });
                        }
                    }

                    // Fallback: single Google Web line from interest_over_time
                    if (!datasets.length) {
                        const timeData = this.trendsData.interest_over_time;
                        labels = timeData.map(d => {
                            const date = new Date(d.date);
                            return date.toLocaleDateString('en-US', { month: 'short', year: '2-digit' });
                        });

                        const keywords = Object.keys(timeData[0] || {}).filter(k => k !== 'date' && k !== 'isPartial');
                        const colors = ['#3b82f6', '#ef4444', '#22c55e', '#f59e0b', '#8b5cf6'];

                        keywords.forEach((keyword, idx) => {
                            datasets.push({
                                label: keyword,
                                data: timeData.map(d => d[keyword] || 0),
                                borderColor: colors[idx % colors.length],
                                backgroundColor: colors[idx % colors.length] + '20',
                                fill: true,
                                tension: 0.4,
                                pointRadius: 0,
                                pointHoverRadius: 4,
                            });
                        });
                    }

                    this.trendsChart = new Chart(ctx, {
                        type: 'line',
                        data: { labels, datasets },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            interaction: { intersect: false, mode: 'index' },
                            plugins: {
                                legend: {
                                    display: true,
                                    position: 'top',
                                    labels: { boxWidth: 12, padding: 8, font: { size: 11 } }
                                },
                                tooltip: {
                                    backgroundColor: 'white',
                                    titleColor: '#1e293b',
                                    bodyColor: '#475569',
                                    borderColor: '#e2e8f0',
                                    borderWidth: 1,
                                    cornerRadius: 8,
                                    padding: 12,
                                }
                            },
                            scales: {
                                x: {
                                    grid: { display: false },
                                    ticks: { font: { size: 10 }, maxRotation: 0 }
                                },
                                y: {
                                    beginAtZero: true,
                                    max: 100,
                                    grid: { color: '#f1f5f9' },
                                    ticks: {
                                        font: { size: 10 },
                                        callback: (value) => value
                                    },
                                    title: {
                                        display: true,
                                        text: 'Interest (0-100)',
                                        font: { size: 10 },
                                        color: '#94a3b8'
                                    }
                                }
                            }
                        }
                    });
                },

                getRegionInterest(region) {
                    // Handle different data structures from pytrends
                    if (typeof region === 'object') {
                        // Try common field names
                        return region.interest || region.value || region[Object.keys(region).find(k => k !== 'region' && k !== 'geoName')] || 0;
                    }
                    return 0;
                },

                getOpportunities() {
                    const opps = [];
                    const platforms = this.results?.platforms || [];
                    const trends = this.trendsData;

                    // Platform gap detection
                    const google = platforms.find(p => p.platform === 'google');
                    const youtube = platforms.find(p => p.platform === 'youtube');
                    const tiktok = platforms.find(p => p.platform === 'tiktok');

                    if (google?.normalized_score > 40 && youtube?.normalized_score < 20) {
                        opps.push({
                            title: 'YouTube Video Opportunity',
                            description: `High Google search (${google.normalized_score}/100) but low YouTube presence (${youtube.normalized_score}/100). Creating video content could capture unmet demand.`,
                            priority: 'high',
                            icon: 'fab fa-youtube text-red-500',
                            iconBg: 'bg-red-100',
                        });
                    }

                    if (google?.normalized_score > 30 && (!tiktok || tiktok.normalized_score < 15)) {
                        opps.push({
                            title: 'TikTok Content Gap',
                            description: 'Strong search demand but low TikTok presence. Short-form video content could reach a new audience.',
                            priority: 'medium',
                            icon: 'fab fa-tiktok text-black',
                            iconBg: 'bg-slate-100',
                        });
                    }

                    // Rising demand from trends
                    if (trends?.insights) {
                        const trendUp = trends.insights.find(i => i.type === 'trend_up');
                        if (trendUp) {
                            opps.push({
                                title: 'Rising Search Demand',
                                description: trendUp.description,
                                priority: 'high',
                                icon: 'fas fa-arrow-trend-up text-green-600',
                                iconBg: 'bg-green-100',
                            });
                        }
                    }

                    // Seasonality alert
                    if (trends?.seasonality?.seasonality_strength === 'high') {
                        opps.push({
                            title: `Seasonal Peak: ${trends.seasonality.peak_month}`,
                            description: `Interest peaks in ${trends.seasonality.peak_month} (index: ${trends.seasonality.peak_interest}). Plan campaigns and content ahead of the peak.`,
                            priority: 'medium',
                            icon: 'fas fa-calendar-alt text-amber-600',
                            iconBg: 'bg-amber-100',
                        });
                    }

                    // Social-to-search signal from correlation
                    if (trends?.correlation_analysis?.pairs?.length) {
                        const grangerPair = trends.correlation_analysis.pairs.find(
                            p => p.granger_b_causes_a?.significant || p.granger_a_causes_b?.significant
                        );
                        if (grangerPair) {
                            const gcInsight = trends.correlation_analysis.insights.find(i => i.includes('Granger'));
                            opps.push({
                                title: 'Predictive Signal Detected',
                                description: gcInsight || `${grangerPair.platform_a} and ${grangerPair.platform_b} show statistically significant predictive relationship (Granger causality).`,
                                priority: 'high',
                                icon: 'fas fa-bolt text-purple-600',
                                iconBg: 'bg-purple-100',
                            });
                        } else {
                            const leadInsight = trends.correlation_analysis.insights.find(i => i.includes('lead'));
                            if (leadInsight) {
                                opps.push({
                                    title: 'Cross-Platform Lead Signal',
                                    description: leadInsight,
                                    priority: 'medium',
                                    icon: 'fas fa-link text-indigo-600',
                                    iconBg: 'bg-indigo-100',
                                });
                            }
                        }
                    }

                    // Breakout queries
                    if (trends?.rising_queries?.some(q => q.value === 'Breakout')) {
                        const breakouts = trends.rising_queries.filter(q => q.value === 'Breakout').map(q => q.query).slice(0, 3);
                        opps.push({
                            title: 'Breakout Search Terms',
                            description: `Explosive growth detected: ${breakouts.join(', ')}. These emerging terms represent immediate content opportunities.`,
                            priority: 'high',
                            icon: 'fas fa-rocket text-pink-600',
                            iconBg: 'bg-pink-100',
                        });
                    }

                    return opps;
                },

            };
        }
    </script>
</body>
</html>
