<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Demand Distribution - Total Demand</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        [x-cloak] { display: none !important; }
        * { font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; }
        .card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08), 0 4px 12px rgba(0,0,0,0.04);
            border: 1px solid rgba(0,0,0,0.06);
        }
        .card-hover:hover {
            box-shadow: 0 4px 20px rgba(0,0,0,0.08), 0 8px 24px rgba(0,0,0,0.06);
            transform: translateY(-1px);
            transition: all 0.2s ease;
        }
        .platform-bar {
            transition: width 0.8s ease-out;
        }
        .btn-primary {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            transition: all 0.2s ease;
        }
        .btn-primary:hover {
            background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
        }
        .insight-card {
            transition: all 0.2s ease;
        }
        .insight-card:hover {
            transform: translateY(-2px);
        }
        .select-modern {
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%236b7280'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            background-size: 16px;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 min-h-screen" x-data="demandDashboard()">
    <!-- Header -->
    <header class="bg-white/80 backdrop-blur-lg border-b border-slate-200/60 sticky top-0 z-50">
        <div class="max-w-6xl mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-blue-500 to-indigo-600 flex items-center justify-center">
                        <i class="fas fa-chart-pie text-white text-lg"></i>
                    </div>
                    <div>
                        <h1 class="text-lg font-semibold text-slate-900">Total Demand</h1>
                        <span class="text-xs text-slate-500">Cross-Platform Demand Intelligence</span>
                    </div>
                </div>
                <nav class="flex items-center space-x-2">
                    <a href="/home" class="px-4 py-2 rounded-lg text-slate-600 hover:bg-slate-100 text-sm font-medium transition">
                        Keywords
                    </a>
                    <a href="/demand" class="px-4 py-2 rounded-lg bg-blue-50 text-blue-600 text-sm font-medium">
                        Demand
                    </a>
                    <a href="/compare" class="px-4 py-2 rounded-lg text-slate-600 hover:bg-slate-100 text-sm font-medium transition">
                        Compare
                    </a>
                </nav>
            </div>
        </div>
    </header>

    <main class="max-w-6xl mx-auto px-6 py-8">
        <!-- Search Section -->
        <div class="card p-6 mb-8">
            <div class="flex items-center justify-between mb-6">
                <div>
                    <h2 class="text-xl font-semibold text-slate-900">Analyze Demand Distribution</h2>
                    <p class="text-slate-500 text-sm mt-1">
                        Discover where your audience searches across platforms
                    </p>
                </div>
            </div>

            <div class="space-y-4">
                <!-- Main Search Input -->
                <div class="flex flex-col lg:flex-row gap-4">
                    <div class="flex-1">
                        <label class="block text-sm font-medium text-slate-700 mb-2">Keywords</label>
                        <input
                            type="text"
                            x-model="searchQuery"
                            @keyup.enter="analyzeKeywords()"
                            placeholder="Enter keywords (comma-separated)"
                            class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 transition"
                        >
                    </div>

                    <!-- Country Selector -->
                    <div class="w-full lg:w-48">
                        <label class="block text-sm font-medium text-slate-700 mb-2">Country</label>
                        <select
                            x-model="selectedCountry"
                            class="select-modern w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 transition pr-10"
                        >
                            <option value="us">United States</option>
                            <option value="de">Germany</option>
                            <option value="uk">United Kingdom</option>
                            <option value="fr">France</option>
                            <option value="es">Spain</option>
                            <option value="it">Italy</option>
                            <option value="nl">Netherlands</option>
                            <option value="au">Australia</option>
                            <option value="ca">Canada</option>
                            <option value="br">Brazil</option>
                            <option value="mx">Mexico</option>
                            <option value="jp">Japan</option>
                        </select>
                    </div>

                    <!-- Language Selector -->
                    <div class="w-full lg:w-48">
                        <label class="block text-sm font-medium text-slate-700 mb-2">Language</label>
                        <select
                            x-model="selectedLanguage"
                            class="select-modern w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 transition pr-10"
                        >
                            <option value="en">English</option>
                            <option value="de">German</option>
                            <option value="fr">French</option>
                            <option value="es">Spanish</option>
                            <option value="it">Italian</option>
                            <option value="nl">Dutch</option>
                            <option value="pt">Portuguese</option>
                            <option value="ja">Japanese</option>
                        </select>
                    </div>

                    <!-- Audience Profile Selector -->
                    <div class="w-full lg:w-56">
                        <label class="block text-sm font-medium text-slate-700 mb-2">Audience Profile</label>
                        <select
                            x-model="selectedProfile"
                            class="select-modern w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 transition pr-10"
                        >
                            <option value="general">General (default)</option>
                            <option value="ecommerce">E-commerce</option>
                            <option value="beauty">Beauty &amp; Lifestyle</option>
                            <option value="gen_z">Gen Z Audience</option>
                            <option value="b2b_tech">B2B / Technology</option>
                            <option value="video_content">Video &amp; Content</option>
                        </select>
                    </div>
                </div>

                <!-- Search Button -->
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-4">
                        <div class="flex flex-wrap gap-2">
                            <span class="text-xs text-slate-400">Try:</span>
                            <button @click="searchQuery = 'lavera cosmetics'; analyzeKeywords()" class="text-xs text-blue-600 hover:text-blue-700 font-medium transition">Cosmetics</button>
                            <button @click="searchQuery = 'running shoes'; analyzeKeywords()" class="text-xs text-blue-600 hover:text-blue-700 font-medium transition">Running</button>
                            <button @click="searchQuery = 'meal prep recipes'; analyzeKeywords()" class="text-xs text-blue-600 hover:text-blue-700 font-medium transition">Food</button>
                        </div>
                        <label class="flex items-center space-x-2 text-xs text-slate-500 cursor-pointer">
                            <input type="checkbox" x-model="forceRefresh" class="rounded border-slate-300 text-blue-600 focus:ring-blue-500">
                            <span>Force refresh data</span>
                        </label>
                    </div>

                    <button
                        @click="analyzeKeywords()"
                        :disabled="isLoading || !searchQuery.trim()"
                        class="btn-primary px-6 py-3 text-white rounded-xl font-medium disabled:opacity-50 disabled:cursor-not-allowed flex items-center space-x-2"
                    >
                        <i :class="isLoading ? 'fas fa-circle-notch fa-spin' : 'fas fa-search'"></i>
                        <span x-text="isLoading ? 'Analyzing...' : 'Analyze'"></span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Results Section -->
        <div x-show="hasResults" x-cloak>
            <!-- Summary Stats Row -->
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-6">
                <div class="card card-hover p-5 bg-gradient-to-br from-blue-50 to-indigo-50 border-blue-100">
                    <p class="text-xs font-medium text-blue-600 uppercase tracking-wide">Demand Index</p>
                    <p class="text-3xl font-bold text-blue-700 mt-1" x-text="(results?.demand_index || 0) + '/100'"></p>
                    <p class="text-xs text-blue-400 mt-1">cross-platform composite score</p>
                </div>
                <div class="card card-hover p-5">
                    <p class="text-xs font-medium text-slate-500 uppercase tracking-wide">Active Platforms</p>
                    <p class="text-2xl font-bold text-slate-900 mt-1" x-text="(results?.platforms || []).filter(p => p.volume > 0).length + ' / 6'"></p>
                    <p class="text-xs text-slate-400 mt-1">platforms with demand signals</p>
                </div>
                <div class="card card-hover p-5">
                    <p class="text-xs font-medium text-slate-500 uppercase tracking-wide">Top Platform</p>
                    <p class="text-2xl font-bold text-slate-900 mt-1" x-text="results?.distribution_summary?.top_platform_name || '-'"></p>
                    <p class="text-xs text-slate-400 mt-1">
                        score: <span x-text="results?.distribution_summary?.top_platform_score || 0"></span>/100
                    </p>
                </div>
            </div>

            <!-- Main Content Grid -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                <!-- Unified Demand Distribution Chart -->
                <div class="lg:col-span-2 card p-6">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-lg font-semibold text-slate-900">Demand Distribution</h3>
                        <div class="flex space-x-2">
                            <button @click="exportPDF()" class="px-3 py-1.5 text-xs font-medium text-slate-600 bg-slate-100 hover:bg-slate-200 rounded-lg transition">
                                <i class="fas fa-file-pdf mr-1"></i> PDF
                            </button>
                            <button @click="exportPPTX()" class="px-3 py-1.5 text-xs font-medium text-slate-600 bg-slate-100 hover:bg-slate-200 rounded-lg transition">
                                <i class="fas fa-file-powerpoint mr-1"></i> PPTX
                            </button>
                        </div>
                    </div>

                    <div class="flex flex-col lg:flex-row gap-8">
                        <!-- Unified Chart (all 6 platforms, normalized scores) -->
                        <div class="w-full lg:w-2/5 flex items-center justify-center">
                            <div class="relative">
                                <canvas id="distributionChart" width="220" height="220"></canvas>
                                <div class="absolute inset-0 flex items-center justify-center pointer-events-none">
                                    <div class="text-center">
                                        <p class="text-2xl font-bold text-blue-700" x-text="(results?.demand_index || 0) + '/100'"></p>
                                        <p class="text-xs text-slate-500">Demand Index</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- All Platforms Unified -->
                        <div class="flex-1">
                            <p class="text-xs font-semibold text-slate-400 uppercase tracking-wider mb-3">
                                <i class="fas fa-chart-bar mr-1"></i> Platform Demand Scores
                                <span class="text-slate-300 font-normal normal-case ml-1">(normalized 0-100)</span>
                            </p>
                            <div class="space-y-3">
                                <template x-for="platform in (results?.platforms || []).filter(p => p.volume > 0)" :key="platform.platform">
                                    <div class="flex items-center group">
                                        <div class="w-8 h-8 rounded-lg flex items-center justify-center" :style="'background-color: ' + platform.color + '15'">
                                            <i :class="platform.icon" :style="'color: ' + platform.color" class="text-sm"></i>
                                        </div>
                                        <div class="flex-1 ml-3">
                                            <div class="flex justify-between text-sm mb-1">
                                                <div class="flex items-center space-x-2">
                                                    <span class="font-medium text-slate-700" x-text="platform.display_name"></span>
                                                    <span class="text-[10px] px-1.5 py-0.5 rounded-full font-medium"
                                                        :class="{
                                                            'bg-green-100 text-green-700': platform.metric_type === 'search_volume',
                                                            'bg-amber-100 text-amber-700': platform.metric_type === 'engagement',
                                                            'bg-purple-100 text-purple-700': platform.metric_type === 'interest_index'
                                                        }"
                                                        x-text="platform.metric_type === 'search_volume' ? 'search' : (platform.metric_type === 'engagement' ? 'social' : 'discovery')"
                                                    ></span>
                                                </div>
                                                <div class="flex items-center space-x-2">
                                                    <span class="text-slate-900 font-semibold" x-text="platform.normalized_score + '/100'"></span>
                                                    <span class="text-slate-400 text-xs" x-text="'(' + platform.percentage + '%)'"></span>
                                                </div>
                                            </div>
                                            <div class="h-2 bg-slate-100 rounded-full overflow-hidden">
                                                <div class="h-full rounded-full platform-bar" :style="'width: ' + Math.max(platform.normalized_score, 1) + '%; background-color: ' + platform.color"></div>
                                            </div>
                                            <p class="text-[10px] text-slate-400 mt-0.5" x-text="'Raw: ' + formatNumber(platform.volume) + ' ' + platform.metric_label.toLowerCase()"></p>
                                        </div>
                                        <div class="w-10 text-right ml-3">
                                            <span x-show="platform.trend === 'growing'" class="text-green-500 text-sm"><i class="fas fa-arrow-up"></i></span>
                                            <span x-show="platform.trend === 'declining'" class="text-red-500 text-sm"><i class="fas fa-arrow-down"></i></span>
                                            <span x-show="platform.trend === 'stable' || !platform.trend" class="text-slate-300 text-sm"><i class="fas fa-minus"></i></span>
                                        </div>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Key Insight Panel -->
                <div class="card p-6 bg-gradient-to-br from-blue-50 to-indigo-50 border-blue-100">
                    <h3 class="text-lg font-semibold text-slate-900 mb-4">Demand Overview</h3>

                    <div class="text-center py-4">
                        <p class="text-5xl font-bold text-blue-600" x-text="results?.demand_index || 0"></p>
                        <p class="text-slate-500 mt-1 font-medium text-sm">Demand Index <span class="text-slate-400">/ 100</span></p>
                    </div>

                    <div class="bg-white/60 rounded-xl p-4 mt-3">
                        <p class="text-sm text-slate-600">
                            <span class="font-bold text-slate-900" x-text="results?.distribution_summary?.top_platform_name || '-'"></span>
                            leads with a score of
                            <span class="font-bold text-blue-600" x-text="(results?.distribution_summary?.top_platform_score || 0) + '/100'"></span>
                        </p>
                    </div>

                    <!-- Platform raw values summary -->
                    <div class="mt-3 bg-white/40 rounded-xl p-3 space-y-2">
                        <p class="text-xs font-semibold text-slate-500 uppercase tracking-wide">Raw Metrics</p>
                        <template x-for="platform in (results?.platforms || []).filter(p => p.volume > 0)" :key="'insight-' + platform.platform">
                            <div class="flex items-center justify-between text-sm">
                                <span class="text-slate-600">
                                    <i :class="platform.icon" class="mr-1" :style="'color: ' + platform.color"></i>
                                    <span x-text="platform.display_name"></span>
                                </span>
                                <span class="font-semibold text-slate-800" x-text="formatNumber(platform.volume) + (platform.metric_type === 'interest_index' ? '/100' : '')"></span>
                            </div>
                        </template>
                    </div>

                    <div class="mt-3 pt-3 border-t border-blue-100">
                        <p class="text-xs text-slate-500">
                            <i class="fas fa-globe mr-1"></i>
                            Data for: <span x-text="getCountryName()" class="font-medium"></span>
                        </p>
                    </div>
                </div>
            </div>

            <!-- Insights & Recommendations -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                <!-- Insights -->
                <div class="card p-6">
                    <h3 class="text-lg font-semibold text-slate-900 mb-4">Insights</h3>
                    <div class="space-y-3">
                        <template x-for="insight in results?.insights || []" :key="insight.title">
                            <div
                                class="insight-card p-4 rounded-xl border"
                                :class="{
                                    'bg-emerald-50 border-emerald-200': insight.type === 'opportunity',
                                    'bg-blue-50 border-blue-200': insight.type === 'trend',
                                    'bg-amber-50 border-amber-200': insight.type === 'ecommerce',
                                    'bg-pink-50 border-pink-200': insight.type === 'social',
                                    'bg-red-50 border-red-200': insight.type === 'visual'
                                }"
                            >
                                <div class="flex items-start space-x-3">
                                    <div
                                        class="w-8 h-8 rounded-lg flex items-center justify-center flex-shrink-0"
                                        :class="{
                                            'bg-emerald-100': insight.type === 'opportunity',
                                            'bg-blue-100': insight.type === 'trend',
                                            'bg-amber-100': insight.type === 'ecommerce',
                                            'bg-pink-100': insight.type === 'social',
                                            'bg-red-100': insight.type === 'visual'
                                        }"
                                    >
                                        <i
                                            :class="{
                                                'fas fa-rocket text-emerald-600': insight.type === 'opportunity',
                                                'fas fa-chart-line text-blue-600': insight.type === 'trend',
                                                'fas fa-shopping-cart text-amber-600': insight.type === 'ecommerce',
                                                'fas fa-hashtag text-pink-600': insight.type === 'social',
                                                'fas fa-image text-red-600': insight.type === 'visual'
                                            }"
                                        ></i>
                                    </div>
                                    <div>
                                        <p class="font-medium text-slate-900" x-text="insight.title"></p>
                                        <p class="text-sm text-slate-600 mt-1" x-text="insight.description"></p>
                                    </div>
                                </div>
                            </div>
                        </template>
                        <div x-show="!results?.insights?.length" class="text-slate-400 text-center py-8">
                            No specific insights available.
                        </div>
                    </div>
                </div>

                <!-- Recommendations -->
                <div class="card p-6">
                    <h3 class="text-lg font-semibold text-slate-900 mb-4">Recommendations</h3>
                    <div class="space-y-4">
                        <template x-for="(rec, index) in results?.recommendations || []" :key="rec.platform">
                            <div class="p-4 bg-slate-50 rounded-xl">
                                <div class="flex items-center space-x-3 mb-2">
                                    <span class="w-6 h-6 bg-blue-600 text-white rounded-full flex items-center justify-center text-xs font-bold" x-text="index + 1"></span>
                                    <span class="font-semibold text-slate-900" x-text="rec.action"></span>
                                </div>
                                <p class="text-sm text-slate-600 mb-3" x-text="rec.description"></p>
                                <div class="flex flex-wrap gap-2">
                                    <template x-for="tactic in rec.tactics" :key="tactic">
                                        <span class="text-xs bg-white border border-slate-200 text-slate-600 px-2.5 py-1 rounded-full" x-text="tactic"></span>
                                    </template>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>
            </div>

            <!-- Keyword Details Table -->
            <div class="card p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold text-slate-900">Keyword Details</h3>
                    <div class="flex space-x-2">
                        <button @click="exportCSV()" class="px-3 py-1.5 text-xs font-medium text-slate-600 bg-slate-100 hover:bg-slate-200 rounded-lg transition">
                            <i class="fas fa-download mr-1"></i> CSV
                        </button>
                        <button @click="copyToClipboard()" class="px-3 py-1.5 text-xs font-medium text-slate-600 bg-slate-100 hover:bg-slate-200 rounded-lg transition">
                            <i class="fas fa-copy mr-1"></i> Copy
                        </button>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead>
                            <tr class="text-left border-b border-slate-200">
                                <th class="pb-3 pr-4 font-semibold text-slate-500">Keyword</th>
                                <th class="pb-3 px-3 text-right font-semibold text-slate-500" title="Monthly search volume">
                                    <i class="fab fa-google text-blue-500 mr-1"></i>Google
                                </th>
                                <th class="pb-3 px-3 text-right font-semibold text-slate-500" title="Monthly search volume">
                                    <i class="fab fa-youtube text-red-500 mr-1"></i>YouTube
                                </th>
                                <th class="pb-3 px-3 text-right font-semibold text-slate-500" title="Monthly search volume">
                                    <i class="fab fa-amazon text-orange-500 mr-1"></i>Amazon
                                </th>
                                <th class="pb-3 px-3 text-right font-semibold text-slate-500" title="Avg. interactions per video">
                                    <i class="fab fa-tiktok text-slate-700 mr-1"></i>TikTok
                                </th>
                                <th class="pb-3 px-3 text-right font-semibold text-slate-500" title="Avg. interactions per post">
                                    <i class="fab fa-instagram text-pink-500 mr-1"></i>Instagram
                                </th>
                                <th class="pb-3 px-3 text-right font-semibold text-slate-500" title="Interest Index (0-100)">
                                    <i class="fab fa-pinterest text-red-600 mr-1"></i>Pinterest
                                </th>
                                <th class="pb-3 pl-3 text-center font-semibold text-slate-500">Best</th>
                            </tr>
                        </thead>
                        <tbody>
                            <template x-for="(data, keyword) in results?.keyword_details || {}" :key="keyword">
                                <tr class="border-b border-slate-100 hover:bg-slate-50 transition">
                                    <td class="py-3 pr-4 font-medium text-slate-900" x-text="keyword"></td>
                                    <td class="py-3 px-3 text-right text-slate-600" x-text="formatNumber(data.platforms?.google?.volume || 0)"></td>
                                    <td class="py-3 px-3 text-right text-slate-600" x-text="formatNumber(data.platforms?.youtube?.volume || 0)"></td>
                                    <td class="py-3 px-3 text-right text-slate-600" x-text="formatNumber(data.platforms?.amazon?.volume || 0)"></td>
                                    <td class="py-3 px-3 text-right text-slate-600" x-text="formatNumber(data.platforms?.tiktok?.volume || 0)"></td>
                                    <td class="py-3 px-3 text-right text-slate-600" x-text="formatNumber(data.platforms?.instagram?.volume || 0)"></td>
                                    <td class="py-3 px-3 text-right text-slate-600" x-text="formatNumber(data.platforms?.pinterest?.volume || 0)"></td>
                                    <td class="py-3 pl-3 text-center">
                                        <span
                                            class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium"
                                            :class="{
                                                'bg-blue-100 text-blue-700': data.best_platform === 'google',
                                                'bg-red-100 text-red-700': data.best_platform === 'youtube',
                                                'bg-orange-100 text-orange-700': data.best_platform === 'amazon',
                                                'bg-slate-100 text-slate-700': data.best_platform === 'tiktok',
                                                'bg-pink-100 text-pink-700': data.best_platform === 'instagram',
                                                'bg-red-100 text-red-600': data.best_platform === 'pinterest'
                                            }"
                                            x-text="data.best_platform || '-'"
                                        ></span>
                                    </td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>

            </div>

            <!-- FAQ Section -->
            <div class="card p-6 mt-6" x-data="{ openFaq: null }">
                <h3 class="text-lg font-semibold text-slate-900 mb-4">
                    <i class="fas fa-question-circle text-blue-500 mr-2"></i>
                    Frequently Asked Questions
                </h3>
                <div class="space-y-3">
                    <!-- FAQ 1 -->
                    <div class="border border-slate-200 rounded-lg overflow-hidden">
                        <button @click="openFaq = openFaq === 1 ? null : 1" class="w-full flex items-center justify-between p-4 text-left hover:bg-slate-50 transition">
                            <span class="font-medium text-slate-800">What is Total Demand?</span>
                            <i class="fas fa-chevron-down text-slate-400 transition-transform duration-200" :class="{ 'rotate-180': openFaq === 1 }"></i>
                        </button>
                        <div x-show="openFaq === 1" x-collapse class="px-4 pb-4 text-sm text-slate-600">
                            <p>Total Demand is a cross-platform demand intelligence tool. It measures how much demand exists for a brand or keyword across 6 major platforms: Google, YouTube, Amazon, TikTok, Instagram, and Pinterest.</p>
                            <p class="mt-2">Each platform reveals demand through a different signal &mdash; search queries on Google, video engagement on TikTok, visual discovery on Pinterest. Total Demand brings these signals together into one unified view so brands can see where their audience is and where opportunities exist.</p>
                        </div>
                    </div>
                    <!-- FAQ 2 -->
                    <div class="border border-slate-200 rounded-lg overflow-hidden">
                        <button @click="openFaq = openFaq === 2 ? null : 2" class="w-full flex items-center justify-between p-4 text-left hover:bg-slate-50 transition">
                            <span class="font-medium text-slate-800">What is the Demand Index?</span>
                            <i class="fas fa-chevron-down text-slate-400 transition-transform duration-200" :class="{ 'rotate-180': openFaq === 2 }"></i>
                        </button>
                        <div x-show="openFaq === 2" x-collapse class="px-4 pb-4 text-sm text-slate-600">
                            <p>The Demand Index is a composite score from 0 to 100 that summarizes overall demand across all platforms. It works by:</p>
                            <ol class="mt-2 ml-4 list-decimal space-y-1">
                                <li><strong>Normalizing</strong> each platform's raw metric to a 0-100 scale using logarithmic scaling (so a platform with 1,000 searches and one with 10,000 interactions are comparable)</li>
                                <li><strong>Weighting</strong> each platform by its relevance: Google (25%), YouTube (18%), Amazon (18%), TikTok (13%), Instagram (13%), Pinterest (13%)</li>
                                <li><strong>Averaging</strong> the weighted scores into a single number</li>
                            </ol>
                            <p class="mt-2">A Demand Index of 70+ indicates strong cross-platform demand. Below 30 suggests the keyword has limited presence across platforms.</p>
                        </div>
                    </div>
                    <!-- FAQ 3 -->
                    <div class="border border-slate-200 rounded-lg overflow-hidden">
                        <button @click="openFaq = openFaq === 3 ? null : 3" class="w-full flex items-center justify-between p-4 text-left hover:bg-slate-50 transition">
                            <span class="font-medium text-slate-800">How is demand measured on each platform?</span>
                            <i class="fas fa-chevron-down text-slate-400 transition-transform duration-200" :class="{ 'rotate-180': openFaq === 3 }"></i>
                        </button>
                        <div x-show="openFaq === 3" x-collapse class="px-4 pb-4 text-sm text-slate-600">
                            <p>Each platform uses the best available proxy metric for demand:</p>
                            <div class="mt-2 space-y-2">
                                <div class="flex items-start space-x-2">
                                    <span class="w-2 h-2 bg-green-500 rounded-full mt-1.5 flex-shrink-0"></span>
                                    <span><strong>Google, YouTube, Amazon</strong> &mdash; Monthly search volume. People actively searching for a keyword signals direct demand. Source: DataForSEO API.</span>
                                </div>
                                <div class="flex items-start space-x-2">
                                    <span class="w-2 h-2 bg-amber-500 rounded-full mt-1.5 flex-shrink-0"></span>
                                    <span><strong>TikTok, Instagram</strong> &mdash; Average interactions per post/video. We take the higher of avg. likes vs avg. comments (to avoid double-counting, since one person can like AND comment). Each interaction represents approximately one interested person. Source: Apify scrapers.</span>
                                </div>
                                <div class="flex items-start space-x-2">
                                    <span class="w-2 h-2 bg-purple-500 rounded-full mt-1.5 flex-shrink-0"></span>
                                    <span><strong>Pinterest</strong> &mdash; Interest Index (0-100). A relative popularity score from Pinterest Trends where 100 = peak interest. Source: Pinterest Trends API.</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- FAQ 4 -->
                    <div class="border border-slate-200 rounded-lg overflow-hidden">
                        <button @click="openFaq = openFaq === 4 ? null : 4" class="w-full flex items-center justify-between p-4 text-left hover:bg-slate-50 transition">
                            <span class="font-medium text-slate-800">Why normalize to 0-100?</span>
                            <i class="fas fa-chevron-down text-slate-400 transition-transform duration-200" :class="{ 'rotate-180': openFaq === 4 }"></i>
                        </button>
                        <div x-show="openFaq === 4" x-collapse class="px-4 pb-4 text-sm text-slate-600">
                            <p>Different platforms measure demand in completely different units: Google reports monthly search queries (thousands to millions), TikTok reports average likes per video (hundreds to hundreds of thousands), and Pinterest uses a 0-100 index.</p>
                            <p class="mt-2">Comparing 50,000 Google searches to 12,000 TikTok likes directly would be meaningless &mdash; they measure different things. Logarithmic normalization converts each metric to a common 0-100 scale while preserving relative magnitude. This makes the pie chart and demand scores comparable across platforms.</p>
                            <p class="mt-2">The raw values are always shown alongside the normalized scores so you can see the actual numbers.</p>
                        </div>
                    </div>
                    <!-- FAQ 5 -->
                    <div class="border border-slate-200 rounded-lg overflow-hidden">
                        <button @click="openFaq = openFaq === 5 ? null : 5" class="w-full flex items-center justify-between p-4 text-left hover:bg-slate-50 transition">
                            <span class="font-medium text-slate-800">What do the Audience Profiles and platform weights mean?</span>
                            <i class="fas fa-chevron-down text-slate-400 transition-transform duration-200" :class="{ 'rotate-180': openFaq === 5 }"></i>
                        </button>
                        <div x-show="openFaq === 5" x-collapse class="px-4 pb-4 text-sm text-slate-600">
                            <p>The Demand Index is a weighted average of normalized platform scores. Different audiences use platforms differently, so the weights change based on the selected Audience Profile. Each profile is calibrated using industry research data:</p>

                            <div class="mt-3 space-y-3">
                                <div class="bg-slate-50 rounded-lg p-3">
                                    <p class="font-semibold text-slate-700">General (default)</p>
                                    <p class="text-xs text-slate-500 mt-0.5">Google 30% &middot; Amazon 22% &middot; YouTube 15% &middot; Instagram 14% &middot; TikTok 11% &middot; Pinterest 8%</p>
                                    <p class="text-xs text-slate-400 mt-1">Average adult, cross-industry. Based on NP Digital 2025 daily search volume data &amp; Jungle Scout product search studies.</p>
                                </div>
                                <div class="bg-slate-50 rounded-lg p-3">
                                    <p class="font-semibold text-slate-700">E-commerce</p>
                                    <p class="text-xs text-slate-500 mt-0.5">Amazon 32% &middot; Google 25% &middot; Pinterest 14% &middot; Instagram 12% &middot; YouTube 10% &middot; TikTok 7%</p>
                                    <p class="text-xs text-slate-400 mt-1">Purchase-focused brands. Amazon: 56-74% of product searches start here (Jungle Scout 2025). Pinterest: 96% of searches are unbranded.</p>
                                </div>
                                <div class="bg-slate-50 rounded-lg p-3">
                                    <p class="font-semibold text-slate-700">Beauty &amp; Lifestyle</p>
                                    <p class="text-xs text-slate-500 mt-0.5">TikTok 25% &middot; Instagram 22% &middot; Google 18% &middot; Amazon 15% &middot; Pinterest 12% &middot; YouTube 8%</p>
                                    <p class="text-xs text-slate-400 mt-1">Beauty, fashion, food, home. 80% of TikTok Shop US sales are beauty (McKinsey 2025). 70% of shoppers discover next purchase on Instagram.</p>
                                </div>
                                <div class="bg-slate-50 rounded-lg p-3">
                                    <p class="font-semibold text-slate-700">Gen Z Audience</p>
                                    <p class="text-xs text-slate-500 mt-0.5">TikTok 26% &middot; Instagram 22% &middot; YouTube 18% &middot; Google 18% &middot; Pinterest 8% &middot; Amazon 8%</p>
                                    <p class="text-xs text-slate-400 mt-1">Ages 16-27. 64% of Gen Z use TikTok as a search engine (Adobe 2024). Google usage down 25% vs Gen X (Claneo State of Search 2025).</p>
                                </div>
                                <div class="bg-slate-50 rounded-lg p-3">
                                    <p class="font-semibold text-slate-700">B2B / Technology</p>
                                    <p class="text-xs text-slate-500 mt-0.5">Google 40% &middot; YouTube 22% &middot; Amazon 18% &middot; Instagram 8% &middot; TikTok 7% &middot; Pinterest 5%</p>
                                    <p class="text-xs text-slate-400 mt-1">Tech, SaaS, professional services. Google dominates informational/professional search. YouTube critical for reviews and tutorials.</p>
                                </div>
                                <div class="bg-slate-50 rounded-lg p-3">
                                    <p class="font-semibold text-slate-700">Video &amp; Content</p>
                                    <p class="text-xs text-slate-500 mt-0.5">YouTube 30% &middot; TikTok 25% &middot; Instagram 18% &middot; Google 15% &middot; Pinterest 7% &middot; Amazon 5%</p>
                                    <p class="text-xs text-slate-400 mt-1">Entertainment, education, creators. YouTube is the 2nd largest search engine. TikTok is the fastest-growing content discovery platform.</p>
                                </div>
                            </div>

                            <p class="mt-3 text-xs text-slate-400">
                                <strong>Data sources:</strong> NP Digital Web Summit 2025, Jungle Scout Consumer Trends 2025, Claneo State of Search 2025, SparkToro/Datos Q2 2025, McKinsey State of Beauty 2025, Adobe Gen Z Search Study 2024. Weights are re-calibrated periodically as platform usage evolves.
                            </p>
                            <p class="mt-2">If a platform returns zero data, its weight is redistributed among the remaining platforms.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Google Trends Intelligence Section -->
            <div class="card p-6 mt-6" x-show="hasResults">
                <div class="flex items-center justify-between mb-6">
                    <div>
                        <h3 class="text-lg font-semibold text-slate-900">
                            <i class="fab fa-google text-blue-500 mr-2"></i>Google Trends Intelligence
                        </h3>
                        <p class="text-sm text-slate-500 mt-1">Trend analysis, geographic hotspots & related queries</p>
                    </div>
                    <button
                        @click="loadTrendsIntelligence()"
                        :disabled="trendsLoading"
                        class="px-4 py-2 text-sm font-medium text-blue-600 bg-blue-50 hover:bg-blue-100 rounded-lg transition disabled:opacity-50"
                    >
                        <i :class="trendsLoading ? 'fas fa-circle-notch fa-spin' : 'fas fa-chart-line'" class="mr-1"></i>
                        <span x-text="trendsLoading ? 'Loading...' : (trendsData ? 'Refresh' : 'Load Trends')"></span>
                    </button>
                </div>

                <!-- Trends Content -->
                <div x-show="trendsData" x-cloak>
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <!-- Trend Chart -->
                        <div class="lg:col-span-2">
                            <h4 class="text-sm font-semibold text-slate-700 mb-3">
                                <i class="fas fa-chart-area mr-1 text-blue-500"></i>
                                12-Month Interest Trend
                            </h4>
                            <div class="bg-slate-50 rounded-xl p-4 h-64">
                                <canvas id="trendsChart"></canvas>
                            </div>
                            <!-- Seasonality Badge -->
                            <div x-show="trendsData?.seasonality" class="mt-3 flex items-center space-x-2">
                                <span class="text-xs bg-amber-100 text-amber-700 px-2 py-1 rounded-full">
                                    <i class="fas fa-calendar-alt mr-1"></i>
                                    Peak: <span x-text="trendsData?.seasonality?.peak_month"></span>
                                </span>
                                <span class="text-xs text-slate-500">
                                    Seasonality: <span x-text="trendsData?.seasonality?.seasonality_strength" class="font-medium"></span>
                                </span>
                            </div>
                        </div>

                        <!-- Geographic Hotspots -->
                        <div>
                            <h4 class="text-sm font-semibold text-slate-700 mb-3">
                                <i class="fas fa-globe mr-1 text-green-500"></i>
                                Geographic Hotspots
                            </h4>
                            <div class="space-y-2">
                                <template x-for="(region, index) in (trendsData?.interest_by_region || []).slice(0, 8)" :key="region.region">
                                    <div class="flex items-center justify-between p-2 bg-slate-50 rounded-lg">
                                        <div class="flex items-center space-x-2">
                                            <span class="w-5 h-5 rounded-full bg-gradient-to-br from-blue-500 to-indigo-600 flex items-center justify-center text-white text-xs font-bold" x-text="index + 1"></span>
                                            <span class="text-sm text-slate-700" x-text="region.region"></span>
                                        </div>
                                        <div class="flex items-center">
                                            <div class="w-16 h-2 bg-slate-200 rounded-full overflow-hidden mr-2">
                                                <div class="h-full bg-blue-500 rounded-full" :style="'width: ' + getRegionInterest(region) + '%'"></div>
                                            </div>
                                            <span class="text-xs text-slate-500 w-8 text-right" x-text="getRegionInterest(region)"></span>
                                        </div>
                                    </div>
                                </template>
                                <p x-show="!trendsData?.interest_by_region?.length" class="text-sm text-slate-400 text-center py-4">
                                    No geographic data available
                                </p>
                            </div>
                        </div>
                    </div>

                    <!-- Rising Queries Section -->
                    <div class="mt-6 pt-6 border-t border-slate-200">
                        <h4 class="text-sm font-semibold text-slate-700 mb-3">
                            <i class="fas fa-rocket mr-1 text-pink-500"></i>
                            Rising Queries
                            <span class="text-xs font-normal text-slate-400 ml-2">Emerging search terms with high growth</span>
                        </h4>
                        <div class="flex flex-wrap gap-2">
                            <template x-for="query in (trendsData?.rising_queries || []).slice(0, 12)" :key="query.query">
                                <span
                                    class="inline-flex items-center px-3 py-1.5 rounded-full text-sm transition"
                                    :class="query.value === 'Breakout' ? 'bg-pink-100 text-pink-700 ring-1 ring-pink-300' : 'bg-slate-100 text-slate-700'"
                                >
                                    <span x-text="query.query"></span>
                                    <span
                                        class="ml-1.5 text-xs font-medium"
                                        :class="query.value === 'Breakout' ? 'text-pink-500' : 'text-green-600'"
                                        x-text="query.value === 'Breakout' ? 'Breakout' : '+' + query.value + '%'"
                                    ></span>
                                </span>
                            </template>
                            <p x-show="!trendsData?.rising_queries?.length" class="text-sm text-slate-400">
                                No rising queries detected
                            </p>
                        </div>
                    </div>

                    <!-- Trends Insights -->
                    <div x-show="trendsData?.insights?.length" class="mt-6 pt-6 border-t border-slate-200">
                        <h4 class="text-sm font-semibold text-slate-700 mb-3">
                            <i class="fas fa-lightbulb mr-1 text-amber-500"></i>
                            Trends Insights
                        </h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                            <template x-for="insight in trendsData?.insights || []" :key="insight.title">
                                <div
                                    class="p-3 rounded-xl border"
                                    :class="{
                                        'bg-green-50 border-green-200': insight.type === 'trend_up',
                                        'bg-pink-50 border-pink-200': insight.type === 'breakout',
                                        'bg-amber-50 border-amber-200': insight.type === 'seasonality',
                                        'bg-blue-50 border-blue-200': insight.type === 'geographic',
                                        'bg-red-50 border-red-200': insight.type === 'trend_down',
                                        'bg-indigo-50 border-indigo-200': insight.type === 'rising'
                                    }"
                                >
                                    <p class="text-sm font-medium text-slate-800" x-text="insight.title"></p>
                                    <p class="text-xs text-slate-600 mt-1" x-text="insight.description"></p>
                                </div>
                            </template>
                        </div>
                    </div>
                </div>

                <!-- Empty State for Trends -->
                <div x-show="!trendsData && !trendsLoading" class="text-center py-8">
                    <i class="fab fa-google text-4xl text-slate-300 mb-3"></i>
                    <p class="text-slate-500 text-sm">Click "Load Trends" to fetch Google Trends data</p>
                    <p class="text-slate-400 text-xs mt-1">Includes trend charts, geographic hotspots, and rising queries</p>
                </div>
            </div>

            <!-- Meta Audience Reach Section -->
            <div class="card p-6 mt-6" x-show="hasResults">
                <div class="flex items-center justify-between mb-6">
                    <div>
                        <h3 class="text-lg font-semibold text-slate-900">
                            <i class="fab fa-meta text-blue-600 mr-2"></i>Audience Reach (Meta)
                        </h3>
                        <p class="text-sm text-slate-500 mt-1">Estimated reachable audience on Facebook &amp; Instagram</p>
                    </div>
                    <button
                        @click="loadAudienceReach()"
                        :disabled="audienceLoading"
                        class="px-4 py-2 text-sm font-medium text-blue-600 bg-blue-50 hover:bg-blue-100 rounded-lg transition disabled:opacity-50"
                    >
                        <i :class="audienceLoading ? 'fas fa-circle-notch fa-spin' : 'fas fa-users'" class="mr-1"></i>
                        <span x-text="audienceLoading ? 'Loading...' : (audienceData ? 'Refresh' : 'Load Audience')"></span>
                    </button>
                </div>

                <!-- Not Configured State -->
                <div x-show="audienceData?.status === 'not_configured'" class="text-center py-6">
                    <i class="fas fa-cog text-3xl text-slate-300 mb-3"></i>
                    <p class="text-slate-500 text-sm" x-text="audienceData?.message"></p>
                </div>

                <!-- Audience Data -->
                <div x-show="audienceData?.status === 'ok'" x-cloak>
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <!-- Total Reach Card -->
                        <div class="bg-gradient-to-br from-indigo-50 to-purple-50 rounded-xl p-5 border border-indigo-100">
                            <p class="text-xs font-medium text-indigo-600 uppercase tracking-wide">Monthly Reachable Audience</p>
                            <p class="text-3xl font-bold text-indigo-700 mt-2"
                               x-text="formatLargeNumber(audienceData?.audience?.total_reach?.estimate_mau_upper_bound)"></p>
                            <p class="text-xs text-indigo-400 mt-1">
                                Range: <span x-text="formatLargeNumber(audienceData?.audience?.total_reach?.estimate_mau_lower_bound)"></span>
                                &ndash; <span x-text="formatLargeNumber(audienceData?.audience?.total_reach?.estimate_mau_upper_bound)"></span>
                            </p>
                            <p class="text-xs text-indigo-400 mt-0.5">
                                DAU: <span x-text="formatLargeNumber(audienceData?.audience?.total_reach?.estimate_dau)"></span>
                            </p>
                            <div class="flex items-center space-x-2 mt-3">
                                <i class="fab fa-facebook text-blue-600"></i>
                                <i class="fab fa-instagram text-pink-500"></i>
                                <span class="text-xs text-slate-500">Facebook &amp; Instagram</span>
                            </div>
                        </div>

                        <!-- Matched Keywords -->
                        <div class="lg:col-span-2">
                            <h4 class="text-sm font-semibold text-slate-700 mb-3">
                                <i class="fas fa-bullseye mr-1 text-indigo-500"></i>Keyword &rarr; Interest Mapping
                            </h4>
                            <div class="space-y-2">
                                <template x-for="match in audienceData?.audience?.matched_keywords || []" :key="match.keyword">
                                    <div class="flex items-center justify-between p-3 bg-slate-50 rounded-lg">
                                        <div>
                                            <span class="text-sm font-medium text-slate-800" x-text="match.keyword"></span>
                                            <span class="text-xs text-slate-400 ml-2">
                                                &rarr; <span x-text="match.interest_name"></span>
                                            </span>
                                        </div>
                                        <div class="text-right">
                                            <span class="text-sm font-semibold text-indigo-600" x-text="formatLargeNumber(match.estimate_mau_upper_bound)"></span>
                                            <span class="text-xs text-slate-400"> MAU</span>
                                        </div>
                                    </div>
                                </template>
                                <!-- Unmatched keywords -->
                                <template x-for="kw in audienceData?.audience?.unmatched_keywords || []" :key="kw">
                                    <div class="flex items-center p-3 bg-amber-50 rounded-lg border border-amber-100">
                                        <i class="fas fa-exclamation-triangle text-amber-400 mr-2"></i>
                                        <span class="text-sm text-amber-700">
                                            "<span x-text="kw"></span>" &mdash; no matching Meta interest found
                                        </span>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </div>

                    <!-- Demographics Breakdown -->
                    <div x-show="audienceData?.audience?.demographics" class="mt-6 pt-6 border-t border-slate-200">
                        <h4 class="text-sm font-semibold text-slate-700 mb-3">
                            <i class="fas fa-chart-bar mr-1 text-purple-500"></i>
                            Demographic Breakdown
                        </h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- Age Group Bars -->
                            <div>
                                <p class="text-xs text-slate-500 mb-2 uppercase tracking-wide">By Age Group (DAU)</p>
                                <div class="space-y-2">
                                    <template x-for="group in audienceData?.audience?.demographics?.age_groups || []" :key="group.range">
                                        <div>
                                            <div class="flex justify-between text-xs mb-1">
                                                <span class="text-slate-600" x-text="group.range"></span>
                                                <span class="text-slate-800 font-medium" x-text="formatLargeNumber(group.total)"></span>
                                            </div>
                                            <div class="h-3 bg-slate-100 rounded-full overflow-hidden flex">
                                                <div class="h-full bg-blue-400 rounded-l-full"
                                                     :style="'width:' + getGenderPercent(group, 'male') + '%'"
                                                     :title="'Male: ' + formatLargeNumber(group.male)"></div>
                                                <div class="h-full bg-pink-400 rounded-r-full"
                                                     :style="'width:' + getGenderPercent(group, 'female') + '%'"
                                                     :title="'Female: ' + formatLargeNumber(group.female)"></div>
                                            </div>
                                        </div>
                                    </template>
                                </div>
                                <div class="flex items-center space-x-4 mt-3 text-xs text-slate-400">
                                    <span><span class="inline-block w-2.5 h-2.5 bg-blue-400 rounded-full mr-1"></span>Male</span>
                                    <span><span class="inline-block w-2.5 h-2.5 bg-pink-400 rounded-full mr-1"></span>Female</span>
                                </div>
                            </div>
                            <!-- Gender Split -->
                            <div class="flex flex-col items-center justify-center">
                                <p class="text-xs text-slate-500 mb-3 uppercase tracking-wide">Gender Split</p>
                                <div class="flex items-center space-x-8">
                                    <div class="text-center">
                                        <i class="fas fa-mars text-blue-500 text-2xl"></i>
                                        <p class="text-lg font-bold text-blue-600 mt-1"
                                           x-text="Math.round((audienceData?.audience?.demographics?.gender_split?.male || 0) * 100) + '%'"></p>
                                        <p class="text-xs text-slate-400">Male</p>
                                    </div>
                                    <div class="text-center">
                                        <i class="fas fa-venus text-pink-500 text-2xl"></i>
                                        <p class="text-lg font-bold text-pink-600 mt-1"
                                           x-text="Math.round((audienceData?.audience?.demographics?.gender_split?.female || 0) * 100) + '%'"></p>
                                        <p class="text-xs text-slate-400">Female</p>
                                    </div>
                                </div>
                                <p class="text-xs text-slate-400 mt-3">
                                    Total DAU: <span x-text="formatLargeNumber(audienceData?.audience?.demographics?.total_dau)"></span>
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Empty State -->
                <div x-show="!audienceData && !audienceLoading" class="text-center py-8">
                    <i class="fab fa-meta text-4xl text-slate-300 mb-3"></i>
                    <p class="text-slate-500 text-sm">Click "Load Audience" to estimate reachable audience on Facebook &amp; Instagram</p>
                    <p class="text-slate-400 text-xs mt-1">Uses Meta Marketing API (no ad spend required)</p>
                </div>
            </div>
        </div>

        <!-- Empty State -->
        <div x-show="!hasResults && !isLoading" class="text-center py-20">
            <div class="inline-block p-8 bg-white rounded-2xl shadow-sm mb-6">
                <i class="fas fa-chart-pie text-6xl text-slate-300"></i>
            </div>
            <h2 class="text-2xl font-bold text-slate-900 mb-2">Discover Where Your Audience Searches</h2>
            <p class="text-slate-500 max-w-md mx-auto">
                Enter keywords above to analyze demand across Google, YouTube, Amazon, TikTok, Instagram, and Pinterest.
            </p>
        </div>

        <!-- Loading State -->
        <div x-show="isLoading" class="text-center py-20">
            <div class="inline-block p-8 bg-white rounded-2xl shadow-sm mb-6">
                <i class="fas fa-circle-notch fa-spin text-6xl text-blue-500"></i>
            </div>
            <h2 class="text-2xl font-bold text-slate-900 mb-2">Analyzing Demand...</h2>
            <p class="text-slate-500">Fetching data from 6 platforms. This may take 15-30 seconds.</p>
        </div>
    </main>

    <!-- Footer -->
    <footer class="border-t border-slate-200 mt-16 py-8 bg-white">
        <div class="max-w-6xl mx-auto px-6 text-center">
            <p class="text-slate-600 font-medium">Total Demand</p>
            <p class="text-slate-400 text-sm mt-1">Cross-Platform Demand Intelligence</p>
            <p class="text-slate-300 text-xs mt-4">Data: Google (DataForSEO) | YouTube (Google Trends / Estimate) | Amazon (DataForSEO) | TikTok/Instagram (Apify) | Pinterest (Trends)</p>
        </div>
    </footer>

    <script>
        function demandDashboard() {
            return {
                searchQuery: '',
                selectedCountry: 'us',
                selectedLanguage: 'en',
                selectedProfile: 'general',
                forceRefresh: false,
                isLoading: false,
                results: null,
                chart: null,
                trendsData: null,
                trendsLoading: false,
                trendsChart: null,
                audienceData: null,
                audienceLoading: false,

                get hasResults() {
                    return this.results && this.results.total_demand > 0;
                },

                getCountryName() {
                    const countries = {
                        'us': 'United States',
                        'de': 'Germany',
                        'uk': 'United Kingdom',
                        'fr': 'France',
                        'es': 'Spain',
                        'it': 'Italy',
                        'nl': 'Netherlands',
                        'au': 'Australia',
                        'ca': 'Canada',
                        'br': 'Brazil',
                        'mx': 'Mexico',
                        'jp': 'Japan'
                    };
                    return countries[this.selectedCountry] || this.selectedCountry;
                },

                getTopPlatform() {
                    if (!this.results?.platforms?.length) return null;
                    return this.results.platforms.reduce((max, p) => p.volume > (max?.volume || 0) ? p : max, null);
                },

                getPlatformByName(name) {
                    return (this.results?.platforms || []).find(p => p.platform === name);
                },

                hasDataQualityIssue() {
                    if (!this.results?.platforms) return false;
                    const youtube = this.results.platforms.find(p => p.platform === 'youtube');
                    const amazon = this.results.platforms.find(p => p.platform === 'amazon');
                    return (youtube?.volume === 0) || (amazon?.volume === 0);
                },

                async analyzeKeywords() {
                    if (!this.searchQuery.trim()) return;

                    this.isLoading = true;
                    this.results = null;
                    this.trendsData = null;  // Reset trends data for new search
                    this.audienceData = null;  // Reset audience data for new search

                    try {
                        const params = new URLSearchParams({
                            keywords: this.searchQuery,
                            country: this.selectedCountry,
                            language: this.selectedLanguage,
                            weight_preset: this.selectedProfile,
                            refresh: this.forceRefresh ? 'true' : 'false'
                        });

                        const response = await fetch(`/api/demand/analyze?${params}`);
                        const data = await response.json();

                        if (response.ok) {
                            this.results = data;
                            // Double nextTick + requestAnimationFrame to ensure x-show has
                            // made the canvas visible before Chart.js measures dimensions
                            this.$nextTick(() => {
                                requestAnimationFrame(() => this.renderChart());
                            });
                        } else {
                            alert('Error: ' + (data.detail || 'Analysis failed'));
                        }
                    } catch (error) {
                        console.error('Error:', error);
                        alert('Failed to analyze keywords. Please try again.');
                    } finally {
                        this.isLoading = false;
                    }
                },

                renderChart() {
                    const ctx = document.getElementById('distributionChart');
                    if (!ctx) return;

                    if (this.chart) {
                        this.chart.destroy();
                    }

                    // Show ALL platforms with normalized scores (unified view)
                    const platforms = (this.results?.platforms || []).filter(p => p.normalized_score > 0);

                    this.chart = new Chart(ctx, {
                        type: 'doughnut',
                        data: {
                            labels: platforms.map(p => p.display_name),
                            datasets: [{
                                data: platforms.map(p => p.normalized_score),
                                backgroundColor: platforms.map(p => p.color),
                                borderWidth: 0,
                                borderRadius: 4,
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: true,
                            plugins: {
                                legend: { display: false },
                                tooltip: {
                                    backgroundColor: 'white',
                                    titleColor: '#1e293b',
                                    bodyColor: '#475569',
                                    borderColor: '#e2e8f0',
                                    borderWidth: 1,
                                    cornerRadius: 8,
                                    padding: 12,
                                    callbacks: {
                                        label: (context) => {
                                            const idx = context.dataIndex;
                                            const p = platforms[idx];
                                            const score = p.normalized_score;
                                            const raw = this.formatNumber(p.volume);
                                            const label = p.metric_label.toLowerCase();
                                            return `${context.label}: ${score}/100 (raw: ${raw} ${label})`;
                                        }
                                    }
                                }
                            },
                            cutout: '70%',
                        }
                    });
                },

                formatNumber(num) {
                    if (num >= 1000000) {
                        return (num / 1000000).toFixed(1) + 'M';
                    } else if (num >= 1000) {
                        return (num / 1000).toFixed(1) + 'K';
                    }
                    return num?.toLocaleString() || '0';
                },

                exportCSV() {
                    if (!this.results) return;
                    const profileLabel = this.results.weight_preset_label || 'General';
                    const headers = ['Keyword', 'Google (searches)', 'YouTube (searches)', 'Amazon (searches)', 'TikTok (avg interactions)', 'Instagram (avg interactions)', 'Pinterest (interest 0-100)', 'Best Platform'];
                    const rows = [`# Audience Profile: ${profileLabel}`, headers.join(',')];
                    for (const [keyword, data] of Object.entries(this.results.keyword_details || {})) {
                        const row = [
                            `"${keyword}"`,
                            data.platforms?.google?.volume || 0,
                            data.platforms?.youtube?.volume || 0,
                            data.platforms?.amazon?.volume || 0,
                            data.platforms?.tiktok?.volume || 0,
                            data.platforms?.instagram?.volume || 0,
                            data.platforms?.pinterest?.volume || 0,
                            data.best_platform || ''
                        ];
                        rows.push(row.join(','));
                    }
                    const csv = rows.join('\n');
                    const blob = new Blob([csv], { type: 'text/csv' });
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'total_demand_analysis.csv';
                    a.click();
                },

                copyToClipboard() {
                    if (!this.results) return;
                    const platforms = (this.results.platforms || []).filter(p => p.volume > 0);

                    const profileLabel = this.results.weight_preset_label || 'General';
                    const summary = `Total Demand Analysis (${this.getCountryName()})
============================
Audience Profile: ${profileLabel}

Demand Index: ${this.results.demand_index}/100 (cross-platform composite score)

Platform Breakdown:
${platforms.map(p => `  - ${p.display_name}: ${p.normalized_score}/100 (raw: ${this.formatNumber(p.volume)} ${p.metric_label.toLowerCase()})`).join('\n')}

Top Platform: ${this.results.distribution_summary?.top_platform_name || '-'} (${this.results.distribution_summary?.top_platform_score || 0}/100)

Generated by Total Demand  Cross-Platform Demand Intelligence`;
                    navigator.clipboard.writeText(summary).then(() => {
                        alert('Summary copied to clipboard!');
                    });
                },

                exportPDF() {
                    if (!this.searchQuery.trim()) return;
                    const params = new URLSearchParams({
                        keywords: this.searchQuery,
                        title: 'Demand Distribution Analysis',
                        country: this.selectedCountry
                    });
                    window.open(`/api/export/pdf?${params}`, '_blank');
                },

                exportPPTX() {
                    if (!this.searchQuery.trim()) return;
                    const params = new URLSearchParams({
                        keywords: this.searchQuery,
                        title: 'Demand Distribution Analysis',
                        country: this.selectedCountry
                    });
                    window.open(`/api/export/pptx?${params}`, '_blank');
                },

                async loadTrendsIntelligence() {
                    if (!this.searchQuery.trim()) return;

                    this.trendsLoading = true;

                    try {
                        const params = new URLSearchParams({
                            keywords: this.searchQuery,
                            country: this.selectedCountry.toUpperCase(),
                            timeframe: 'today 12-m'
                        });

                        const response = await fetch(`/api/trends/intelligence?${params}`);
                        const data = await response.json();

                        if (response.ok) {
                            this.trendsData = data;
                            this.$nextTick(() => this.renderTrendsChart());
                        } else {
                            console.error('Trends error:', data);
                            alert('Error loading trends: ' + (data.detail || 'Failed to fetch trends'));
                        }
                    } catch (error) {
                        console.error('Trends fetch error:', error);
                        alert('Failed to load Google Trends data. Please try again.');
                    } finally {
                        this.trendsLoading = false;
                    }
                },

                async loadAudienceReach() {
                    if (!this.searchQuery.trim()) return;

                    this.audienceLoading = true;

                    try {
                        const params = new URLSearchParams({
                            keywords: this.searchQuery,
                            country: this.selectedCountry.toUpperCase(),
                            include_demographics: 'true'
                        });

                        const response = await fetch(`/api/audience/reach?${params}`);
                        const data = await response.json();

                        if (response.ok) {
                            this.audienceData = data;
                        } else {
                            console.error('Audience reach error:', data);
                            alert('Error loading audience data: ' + (data.detail || 'Failed to fetch audience reach'));
                        }
                    } catch (error) {
                        console.error('Audience reach fetch error:', error);
                        alert('Failed to load audience reach data. Please try again.');
                    } finally {
                        this.audienceLoading = false;
                    }
                },

                renderTrendsChart() {
                    const ctx = document.getElementById('trendsChart');
                    if (!ctx || !this.trendsData?.interest_over_time) return;

                    if (this.trendsChart) {
                        this.trendsChart.destroy();
                    }

                    const timeData = this.trendsData.interest_over_time;
                    const labels = timeData.map(d => {
                        const date = new Date(d.date);
                        return date.toLocaleDateString('en-US', { month: 'short', year: '2-digit' });
                    });

                    // Get all keywords from the data
                    const keywords = Object.keys(timeData[0] || {}).filter(k => k !== 'date' && k !== 'isPartial');
                    const colors = ['#3b82f6', '#ef4444', '#22c55e', '#f59e0b', '#8b5cf6'];

                    const datasets = keywords.map((keyword, idx) => ({
                        label: keyword,
                        data: timeData.map(d => d[keyword] || 0),
                        borderColor: colors[idx % colors.length],
                        backgroundColor: colors[idx % colors.length] + '20',
                        fill: true,
                        tension: 0.4,
                        pointRadius: 0,
                        pointHoverRadius: 4,
                    }));

                    this.trendsChart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: labels,
                            datasets: datasets
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            interaction: {
                                intersect: false,
                                mode: 'index'
                            },
                            plugins: {
                                legend: {
                                    display: keywords.length > 1,
                                    position: 'top',
                                    labels: {
                                        boxWidth: 12,
                                        padding: 8,
                                        font: { size: 11 }
                                    }
                                },
                                tooltip: {
                                    backgroundColor: 'white',
                                    titleColor: '#1e293b',
                                    bodyColor: '#475569',
                                    borderColor: '#e2e8f0',
                                    borderWidth: 1,
                                    cornerRadius: 8,
                                    padding: 12,
                                }
                            },
                            scales: {
                                x: {
                                    grid: { display: false },
                                    ticks: { font: { size: 10 }, maxRotation: 0 }
                                },
                                y: {
                                    beginAtZero: true,
                                    max: 100,
                                    grid: { color: '#f1f5f9' },
                                    ticks: {
                                        font: { size: 10 },
                                        callback: (value) => value + '%'
                                    }
                                }
                            }
                        }
                    });
                },

                getRegionInterest(region) {
                    // Handle different data structures from pytrends
                    if (typeof region === 'object') {
                        // Try common field names
                        return region.interest || region.value || region[Object.keys(region).find(k => k !== 'region' && k !== 'geoName')] || 0;
                    }
                    return 0;
                },

                formatLargeNumber(num) {
                    if (!num && num !== 0) return '';
                    if (num >= 1000000000) return (num / 1000000000).toFixed(1) + 'B';
                    if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
                    if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
                    return num.toLocaleString();
                },

                getGenderPercent(group, gender) {
                    const total = (group.male || 0) + (group.female || 0);
                    if (total === 0) return 50;
                    return Math.round(((group[gender] || 0) / total) * 100);
                }
            };
        }
    </script>
</body>
</html>
